---
title: "03-fig3-core-virome"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "03-fig3-core-virome"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "03-fig3-core-virome")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "70195058-7d89-416f-88ec-b21d4a17783b")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
 library(here)
library(conflicted) 
library(projthis)
library(tidyverse)
library(TreeSummarizedExperiment)
library(mia)
library(scales)
library(RColorBrewer)
  #devtools::load_all()
})

# ✅ Resolve ALL conflicts
conflicts_prefer(
  dplyr::count,
  dplyr::filter,
  dplyr::select,
  dplyr::lag,
  dplyr::intersect,
  dplyr::left_join,     
  dplyr::right_join,
  dplyr::inner_join,
  dplyr::full_join,
  base::setdiff,
  .quiet = TRUE
)
```

## Tasks

This section is designated for your workflow implementation. **Please write all your analysis and processing code here.**

Maintaining your code within this section ensures a clean project structure and facilitates reproducibility. We recommend organizing your workflow into modular tasks—such as data cleaning, analysis, and visualization—using distinct code chunks.

Below is an example structure to get you started:

### Task Load Data

```{r}
#| label: load-data
#| message: true

# Load TSE
tse <- readRDS(path_source("01-tse-construction", "tse.rds"))

message("✅ TSE loaded: ", nrow(tse), " vOTUs × ", ncol(tse), " samples")
message("   Sample groups: ", paste(levels(colData(tse)$sample_group), collapse = ", "))

```

### Figure 3a: Core Viral Family Composition
#### Identify Core vOTUs and Prepare Data
```{r}
#| label: fig3a-prepare
#| message: true

cat("========================================================================\n")
cat("Figure 3a: Core Viral Community Composition\n")
cat("========================================================================\n\n")

# Extract TPM assay
tpm_assay <- assay(tse, "tpm")

# Identify vOTUs present in each group (TPM > 0)
SA_viruses <- rownames(tpm_assay)[tpm_assay[, colData(tse)$sample_group == "SA"] > 0]
IA_viruses <- rownames(tpm_assay)[tpm_assay[, colData(tse)$sample_group == "IA"] > 0]
DA_viruses <- rownames(tpm_assay)[tpm_assay[, colData(tse)$sample_group == "DA"] > 0]

# Core vOTUs: SA ∩ IA ∩ DA
core_viruses <- Reduce(intersect, list(SA_viruses, IA_viruses, DA_viruses))

cat("Core vOTUs (SA ∩ IA ∩ DA):", length(core_viruses), "\n\n")

# Subset TSE to core vOTUs and SA/IA/DA samples
tse_core <- tse[core_viruses, colData(tse)$sample_group %in% c("SA", "IA", "DA")]

# Clean family annotation
rowData(tse_core)$family_clean <- rowData(tse_core)$family %>%
  str_remove("^\\[.*?\\]_?") %>%
  str_trim() %>%
  replace_na("Unclassified Viruses") %>%
  if_else(. == "" | . == "NA", "Unclassified Viruses", .)

# Calculate family-level relative abundance
tpm_core <- assay(tse_core, "tpm")

family_rel_abundance <- as.data.frame(tpm_core) %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(-vOTU_id, names_to = "sample_id", values_to = "TPM") %>%
  left_join(
    rowData(tse_core) %>% as.data.frame() %>% rownames_to_column("vOTU_id") %>% select(vOTU_id, family_clean),
    by = "vOTU_id"
  ) %>%
  left_join(
    colData(tse_core) %>% as.data.frame() %>% rownames_to_column("sample_id") %>% select(sample_id, sample_group),
    by = "sample_id"
  ) %>%
  group_by(sample_group, family_clean) %>%
  summarise(family_TPM = sum(TPM), .groups = "drop") %>%
  group_by(sample_group) %>%
  mutate(rel_abundance = family_TPM / sum(family_TPM)) %>%
  ungroup() %>%
  select(sample_group, family_clean, rel_abundance)

message("✅ Data prepared for plotting")

```

#### Create Plot

```{r}
#| label: fig3a-plot
#| message: true
#| fig.width: 7
#| fig.height: 6

# Order families by total abundance
family_order <- family_rel_abundance %>%
  group_by(family_clean) %>%
  summarise(total = sum(rel_abundance), .groups = "drop") %>%
  arrange(desc(total)) %>%
  pull(family_clean)

# Put Unclassified at end
if ("Unclassified Viruses" %in% family_order) {
  family_order <- c(setdiff(family_order, "Unclassified Viruses"), "Unclassified Viruses")
}

# Prepare plot data
plot_data <- family_rel_abundance %>%
  mutate(
    family_clean = factor(family_clean, levels = rev(family_order)),
    sample_group = factor(sample_group, levels = c("SA", "IA", "DA"))
  )

# Generate colors
n_families <- length(family_order)
if (n_families <= 12) {
  colors <- brewer.pal(max(3, n_families), "Set3")[1:n_families]
} else {
  colors <- colorRampPalette(brewer.pal(12, "Set3"))(n_families)
}
names(colors) <- family_order

# Special colors
if ("Unclassified Viruses" %in% family_order) colors["Unclassified Viruses"] <- "#F0F0F0"
if ("Rauchovirus" %in% family_order) colors["Rauchovirus"] <- "#8DA0CB"
if ("Kyanoviridae" %in% family_order) colors["Kyanoviridae"] <- "#FC8D62"

# Create plot
p_fig3a <- ggplot(plot_data, aes(x = sample_group, y = rel_abundance, fill = family_clean)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7, color = "black", linewidth = 0.3) +
  scale_fill_manual(values = colors, name = "Family", breaks = family_order) +
  scale_y_continuous(
    labels = function(x) sprintf("%.1f", x),
    limits = c(0, 1),
    breaks = seq(0, 1, 0.2),
    expand = expansion(mult = c(0, 0.02))
  ) +
  labs(x = NULL, y = "Relative Abundance") +
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    axis.text.x = element_text(color = "black", size = 20),
    axis.text.y = element_text(color = "black", size = 20),
    axis.title.y = element_text(size = 23, face = "plain"),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    legend.position = "right",
    legend.text = element_text(size = 10, face = "italic"),
    legend.title = element_text(size = 12, face = "bold"),
    legend.key.size = unit(0.4, "cm"),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    plot.margin = unit(c(10, 10, 10, 10), "mm"),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA)
  )

print(p_fig3a)

# Save
ggsave(path_target("Fig3a.pdf"), plot = p_fig3a, width = 7, height = 6, dpi = 300)
ggsave(path_target("Fig3a.png"), plot = p_fig3a, width = 7, height = 6, dpi = 300)
write_csv(tibble(vOTU_id = core_viruses), path_target("Fig3a_core_vOTUs.csv"))
write_csv(family_rel_abundance, path_target("Fig3a_family_composition.csv"))

message("✅ Figure 3a completed!")

```



###  Figure 3b: Abundant Viruses in Core Group
####  Identify Abundant vOTUs and Calculate Proportions
```{r}
#| label: fig3b-prepare
#| message: true

cat("\n========================================================================\n")
cat("Figure 3b: Abundant Viruses in Core Group\n")
cat("========================================================================\n\n")

# Calculate relative abundance per sample (all vOTUs)
tpm_all <- assay(tse, "tpm")

abundance_rel <- as.data.frame(tpm_all) %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(-vOTU_id, names_to = "sample_id", values_to = "tpm") %>%
  group_by(sample_id) %>%
  mutate(rel_abundance = tpm / sum(tpm)) %>%
  ungroup()

# Identify abundant vOTUs (≥1% in any sample)
abundant_vOTUs <- abundance_rel %>%
  filter(rel_abundance >= 0.01) %>%
  pull(vOTU_id) %>%
  unique()

# Core & Abundant intersection
core_abundant <- intersect(core_viruses, abundant_vOTUs)

cat("Core vOTUs:", length(core_viruses), "\n")
cat("Abundant vOTUs (≥1%):", length(abundant_vOTUs), "\n")
cat("Core & Abundant:", length(core_abundant), "\n\n")

# Calculate proportions by sample group
prop_data <- tibble()
detailed_stats <- tibble()

for (group in c("SA", "IA", "DA")) {
  sample_ids <- rownames(colData(tse))[colData(tse)$sample_group == group]
  
  # Total TPM of core vOTUs
  core_total <- sum(tpm_all[core_viruses, sample_ids])
  
  # TPM of abundant & core vOTUs
  abundant_core_in_group <- core_abundant[rowSums(tpm_all[core_abundant, sample_ids, drop = FALSE] > 0) > 0]
  abundant_total <- sum(tpm_all[abundant_core_in_group, sample_ids])
  
  # Calculate percentage
  abundant_pct <- (abundant_total / core_total) * 100
  
  cat(sprintf("%s: %.2f%% (%d vOTUs)\n", group, abundant_pct, length(abundant_core_in_group)))
  
  # Store data
  prop_data <- bind_rows(
    prop_data,
    tibble(
      sample = group,
      category = c("Abundant", "Other"),
      proportion = c(abundant_pct, 100 - abundant_pct)
    )
  )
  
  detailed_stats <- bind_rows(
    detailed_stats,
    tibble(
      Sample = group,
      Core_vOTUs = length(core_viruses),
      Abundant_Core_vOTUs = length(abundant_core_in_group),
      Percent = round(abundant_pct, 2)
    )
  )
}

cat("\n")


```




#### Create Donut Chart
```{r}
#| label: fig3b-plot
#| message: true
#| fig.width: 8
#| fig.height: 10

prop_data <- prop_data %>%
  mutate(
    sample = factor(sample, levels = c("SA", "IA", "DA")),
    category = factor(category, levels = c("Abundant", "Other"))
  )

p_fig3b <- ggplot(prop_data, aes(x = 2, y = proportion, fill = category)) +
  geom_bar(stat = "identity", width = 1, color = "white", linewidth = 2) +
  coord_polar(theta = "y") +
  xlim(0.5, 2.5) +
  facet_wrap(~sample, nrow = 3) +
  scale_fill_manual(
    values = c("Abundant" = "#6BA368", "Other" = "#CCCCCC"),
    name = NULL
  ) +
  theme_void(base_size = 24) +
  theme(
    text = element_text(family = "Times", size = 18),
    strip.text = element_text(size = 26, face = "bold", color = "black"),
    legend.position = "right",
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 16, face = "bold"),
    plot.margin = margin(15, 15, 15, 15)
  )

print(p_fig3b)

# Save
ggsave(path_target("Fig3b.pdf"), plot = p_fig3b, width = 8, height = 10, dpi = 300)
ggsave(path_target("Fig3b.png"), plot = p_fig3b, width = 8, height = 10, dpi = 300)
write_csv(prop_data, path_target("Fig3b_proportions.csv"))
write_csv(detailed_stats, path_target("Fig3b_statistics.csv"))
write_csv(tibble(vOTU_id = core_abundant), path_target("Fig3b_core_abundant_vOTUs.csv"))

message("✅ Figure 3b completed!")

```
