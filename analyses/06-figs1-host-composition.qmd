---
title: "06-figs1-host-composition"
title-block-banner: true
author:
  - name: Cunli Pan
  - name: Jinlong Ru
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format:
  gfm: default
reference-location: section
citation-location: document
params:
  name: "06-figs1-host-composition"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is to analyze the taxonomic composition of predicted viral hosts, calculating and visualizing the relative abundance of different host bacterial phyla across ecosystem depths.

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "06-figs1-host-composition")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "d4abc0c1-2a78-4c48-817e-0bf57f83b97d")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false

suppressPackageStartupMessages({
  library(here)
  library(mia)
  library(tidyverse)
  library(data.table)
  library(RColorBrewer)
  library(scales)
  library(patchwork)
})

# Load package utility functions
devtools::load_all(here::here())


```

## Tasks

### Task 1: Load TSE object and extract data
```{r}
#| label: task1-load-data

tse <- readRDS(here("data", "01-tse-construction", "tse.rds"))
tpm_matrix <- assay(tse, "tpm")
host_genome_edges <- metadata(tse)$host_genome_edges

sample_metadata <- colData(tse) %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  dplyr::select(sample_id, sample_group)

message("TSE loaded: ", nrow(tse), " vOTUs, ", ncol(tse), " samples")

```

### Task 2: Prepare-data

```{r}
#| label: task2-prepare-data
# Filter high-confidence predictions
host_high_conf <- host_genome_edges %>%
  dplyr::filter(Confidence.score >= 80)

# Extract taxonomy
host_filtered <- host_high_conf %>%
  mutate(
    Phylum = str_extract(Host.taxonomy, "(?<=p__)[^;]+"),
    Phylum = if_else(is.na(Phylum) | Phylum == "", "Unclassified", Phylum),
    Class = str_extract(Host.taxonomy, "(?<=c__)[^;]+"),
    Class = if_else(is.na(Class) | Class == "", "Unclassified", Class)
  ) %>%
  dplyr::select(vOTU_id, Host.taxonomy, Phylum, Class) %>%
  dplyr::distinct()

# Convert TPM to long format
tpm_long <- tpm_matrix %>%
  as.data.frame() %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "TPM") %>%
  dplyr::filter(TPM > 0)

# Calculate total TPM per sample
sample_total_tpm <- tpm_long %>%
  group_by(sample_id) %>%
  summarise(total_TPM = sum(TPM), .groups = "drop")

message("Data prepared: ", nrow(host_filtered), " vOTU-host pairs")
```


### Task 3: Define-functions

```{r}
#| label: task3-define-functions

# Functions now loaded from R/utils.R:
# - calculate_host_abundance()
# - calculate_host_abundance_normalized()
# - create_stacked_bar()
```



### Task 4: Calculate abundance data

```{r}
#| label: task4-calculate-abundance

phylum_abundance_orig <- calculate_host_abundance(
  host_filtered, tpm_long, sample_total_tpm, sample_metadata, "Phylum"
)

class_abundance_orig <- calculate_host_abundance(
  host_filtered, tpm_long, sample_total_tpm, sample_metadata, "Class"
)

phylum_abundance_norm <- calculate_host_abundance_normalized(
  host_filtered, tpm_long, sample_metadata, "Phylum"
)

class_abundance_norm <- calculate_host_abundance_normalized(
  host_filtered, tpm_long, sample_metadata, "Class"
)

message("Host abundance calculated")

```


### Task 5: Create Figure S1 panels

```{r}
#| label: task5-create-plots
#| fig-width: 12
#| fig-height: 14

p_s1a <- create_stacked_bar(phylum_abundance_orig, "Phylum", 10, FALSE)
p_s1b <- create_stacked_bar(class_abundance_orig, "Class", 15, FALSE)
p_s1c <- create_stacked_bar(phylum_abundance_norm, "Phylum", 10, TRUE)
p_s1d <- create_stacked_bar(class_abundance_norm, "Class", 15, TRUE)

fig_s1_combined <- (p_s1a + p_s1b) / (p_s1c + p_s1d) +
  plot_annotation(
    tag_levels = 'a',
    title = "Figure S1: Predicted viral host composition across groundwater depths"
  ) &
  theme(plot.tag = element_text(size = 18, face = "bold"))

print(fig_s1_combined)


```



### Task 6: Save outputs

```{r}
#| label: task6-save-outputs

figures_dir <- path_target("figures")
data_dir <- path_target("data")
dir.create(figures_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(data_dir, recursive = TRUE, showWarnings = FALSE)

# Save figures
ggsave(file.path(figures_dir, "FigS1a_phylum_original.png"), p_s1a, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1b_class_original.png"), p_s1b, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1c_phylum_normalized.png"), p_s1c, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1d_class_normalized.png"), p_s1d, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1_combined_all_panels.png"), fig_s1_combined, width = 12, height = 12, dpi = 300)

# Save data
write_csv(phylum_abundance_orig, file.path(data_dir, "phylum_abundance_original.csv"))
write_csv(class_abundance_orig, file.path(data_dir, "class_abundance_original.csv"))
write_csv(phylum_abundance_norm, file.path(data_dir, "phylum_abundance_normalized.csv"))
write_csv(class_abundance_norm, file.path(data_dir, "class_abundance_normalized.csv"))

message("Outputs saved to: ", figures_dir)

```
