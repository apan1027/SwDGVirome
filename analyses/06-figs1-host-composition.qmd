---
title: "06-figs1-host-composition"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "06-figs1-host-composition"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "06-figs1-host-composition")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "d4abc0c1-2a78-4c48-817e-0bf57f83b97d")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false

suppressPackageStartupMessages({
  library(here)
  library(mia)
  library(tidyverse)
  library(data.table)
  library(RColorBrewer)
  library(scales)
  library(patchwork)
})


```

## Tasks

This section is designated for your workflow implementation. **Please write all your analysis and processing code here.**

Maintaining your code within this section ensures a clean project structure and facilitates reproducibility. We recommend organizing your workflow into modular tasks—such as data cleaning, analysis, and visualization—using distinct code chunks.

Below is an example structure to get you started:

### Task 1: Load TSE object and extract data
```{r}
#| label: task1-load-data

tse <- readRDS(here("data", "01-tse-construction", "tse.rds"))
tpm_matrix <- assay(tse, "tpm")
host_genome_edges <- metadata(tse)$host_genome_edges

sample_metadata <- colData(tse) %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  dplyr::select(sample_id, sample_group)

message("TSE loaded: ", nrow(tse), " vOTUs, ", ncol(tse), " samples")

```

### Task 2: Prepare-data

```{r}
#| label: task2-prepare-data
# Filter high-confidence predictions
host_high_conf <- host_genome_edges %>%
  dplyr::filter(Confidence.score >= 80)

# Extract taxonomy
host_filtered <- host_high_conf %>%
  mutate(
    Phylum = str_extract(Host.taxonomy, "(?<=p__)[^;]+"),
    Phylum = if_else(is.na(Phylum) | Phylum == "", "Unclassified", Phylum),
    Class = str_extract(Host.taxonomy, "(?<=c__)[^;]+"),
    Class = if_else(is.na(Class) | Class == "", "Unclassified", Class)
  ) %>%
  dplyr::select(vOTU_id, Host.taxonomy, Phylum, Class) %>%
  dplyr::distinct()

# Convert TPM to long format
tpm_long <- tpm_matrix %>%
  as.data.frame() %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "TPM") %>%
  dplyr::filter(TPM > 0)

# Calculate total TPM per sample
sample_total_tpm <- tpm_long %>%
  group_by(sample_id) %>%
  summarise(total_TPM = sum(TPM), .groups = "drop")

message("Data prepared: ", nrow(host_filtered), " vOTU-host pairs")
```


### Task 3: Define-functions

```{r}
#| label: task3-define-functions

# Function 1: Calculate relative abundance (relative to all viruses)
calculate_host_abundance <- function(host_filtered, tpm_long, sample_total_tpm,
                                     sample_metadata, tax_level = "Phylum") {
  
  host_count <- host_filtered %>%
    group_by(vOTU_id) %>%
    summarise(n_hosts = dplyr::n_distinct(!!sym(tax_level)), .groups = "drop")
  
  host_weighted <- host_filtered %>%
    dplyr::left_join(host_count, by = "vOTU_id") %>%
    mutate(weight = 1 / n_hosts) %>%
    dplyr::select(vOTU_id, !!sym(tax_level), weight) %>%
    dplyr::distinct()
  
  host_abundance <- tpm_long %>%
    dplyr::inner_join(host_weighted, by = "vOTU_id", relationship = "many-to-many") %>%
    mutate(weighted_TPM = TPM * weight)
  
  tax_abundance <- host_abundance %>%
    group_by(sample_id, !!sym(tax_level)) %>%
    summarise(tax_TPM = sum(weighted_TPM), .groups = "drop")
  
  tax_rel_abundance <- tax_abundance %>%
    dplyr::left_join(sample_total_tpm, by = "sample_id") %>%
    mutate(rel_abundance = tax_TPM / total_TPM) %>%
    dplyr::select(sample_id, !!sym(tax_level), rel_abundance) %>%
    dplyr::left_join(sample_metadata, by = "sample_id")
  
  return(tax_rel_abundance)
}

# Function 2: Calculate 100% normalized abundance
calculate_host_abundance_normalized <- function(host_filtered, tpm_long,
                                                sample_metadata, tax_level = "Phylum") {
  
  host_count <- host_filtered %>%
    group_by(vOTU_id) %>%
    summarise(n_hosts = dplyr::n_distinct(!!sym(tax_level)), .groups = "drop")
  
  host_weighted <- host_filtered %>%
    dplyr::left_join(host_count, by = "vOTU_id") %>%
    mutate(weight = 1 / n_hosts) %>%
    dplyr::select(vOTU_id, !!sym(tax_level), weight) %>%
    dplyr::distinct()
  
  host_abundance <- tpm_long %>%
    dplyr::inner_join(host_weighted, by = "vOTU_id", relationship = "many-to-many") %>%
    mutate(weighted_TPM = TPM * weight)
  
  tax_abundance <- host_abundance %>%
    group_by(sample_id, !!sym(tax_level)) %>%
    summarise(tax_TPM = sum(weighted_TPM), .groups = "drop")
  
  tax_rel_abundance <- tax_abundance %>%
    group_by(sample_id) %>%
    mutate(
      sample_assigned_total = sum(tax_TPM),
      rel_abundance = tax_TPM / sample_assigned_total
    ) %>%
    ungroup() %>%
    dplyr::select(sample_id, !!sym(tax_level), rel_abundance) %>%
    dplyr::left_join(sample_metadata, by = "sample_id")
  
  return(tax_rel_abundance)
}

# Function 3: Create stacked bar chart
create_stacked_bar <- function(tax_rel_abundance, tax_level = "Phylum", 
                                top_n = 10, normalize = FALSE) {
  
  if (tax_level == "Class") top_n <- 15
  
  tax_totals <- tax_rel_abundance %>%
    group_by(!!sym(tax_level)) %>%
    summarise(total_abund = sum(rel_abundance), .groups = "drop") %>%
    arrange(desc(total_abund))
  
  top_taxa <- tax_totals %>%
    slice_head(n = top_n) %>%
    pull(!!sym(tax_level))
  
  plot_data <- tax_rel_abundance %>%
    mutate(
      Taxa_display = if_else(!!sym(tax_level) %in% top_taxa, 
                             !!sym(tax_level), "Others")
    ) %>%
    group_by(sample_group, Taxa_display) %>%
    summarise(rel_abundance = sum(rel_abundance), .groups = "drop") %>%
    mutate(
      Taxa_display = factor(Taxa_display, levels = rev(c(top_taxa, "Others"))),
      sample_group = factor(sample_group, levels = c("BS", "SA", "IA", "DA"))
    )
  
  n_colors <- length(top_taxa) + 1
  
  if (tax_level == "Phylum") {
    colors <- if (n_colors <= 12) brewer.pal(max(3, n_colors), "Set3") else 
              colorRampPalette(brewer.pal(12, "Set3"))(n_colors)
  } else {
    colors <- if (n_colors <= 12) brewer.pal(max(3, n_colors), "Paired") else 
              colorRampPalette(brewer.pal(12, "Paired"))(n_colors)
  }
  
  names(colors) <- c(top_taxa, "Others")
  colors["Others"] <- "#CCCCCC"
  
  ggplot(plot_data, aes(x = sample_group, y = rel_abundance, fill = Taxa_display)) +
    geom_bar(stat = "identity", position = "stack", width = 0.7, color = NA) +
    scale_fill_manual(values = colors, name = tax_level) +
    scale_y_continuous(
      labels = function(x) sprintf("%.1f", x),
      limits = if (!normalize) c(0, 1) else NULL,
      breaks = if (!normalize) seq(0, 1, 0.2) else waiver(),
      expand = expansion(mult = c(0, 0))
    ) +
    labs(x = NULL, y = "Relative abundance of predicted bacterial hosts") +
    theme_minimal(base_size = 22) +
    theme(
      text = element_text(family = "Times"),
      axis.text = element_text(color = "black", size = 20),
      axis.title.y = element_text(size = 20, face = "plain"),
      axis.title.x = element_blank(),
      axis.line = element_line(color = "black", linewidth = 1),
      axis.ticks = element_line(color = "black", linewidth = 0.8),
      legend.position = "right",
      legend.key.size = unit(0.4, "cm"),
      legend.text = element_text(size = 10, face = "italic"),
      legend.title = element_text(size = 12, face = "bold"),
      panel.grid = element_blank(),
      panel.border = element_blank(),
      plot.margin = margin(10, 10, 10, 10),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA)
    )
}

```



### Task 4: Calculate abundance data 

```{r}
#| label: task4-calculate-abundance

phylum_abundance_orig <- calculate_host_abundance(
  host_filtered, tpm_long, sample_total_tpm, sample_metadata, "Phylum"
)

class_abundance_orig <- calculate_host_abundance(
  host_filtered, tpm_long, sample_total_tpm, sample_metadata, "Class"
)

phylum_abundance_norm <- calculate_host_abundance_normalized(
  host_filtered, tpm_long, sample_metadata, "Phylum"
)

class_abundance_norm <- calculate_host_abundance_normalized(
  host_filtered, tpm_long, sample_metadata, "Class"
)

message("Host abundance calculated")

```


### Task 5: Create Figure S1 panels

```{r}
#| label: task5-create-plots
#| fig-width: 12
#| fig-height: 14

p_s1a <- create_stacked_bar(phylum_abundance_orig, "Phylum", 10, FALSE)
p_s1b <- create_stacked_bar(class_abundance_orig, "Class", 15, FALSE)
p_s1c <- create_stacked_bar(phylum_abundance_norm, "Phylum", 10, TRUE)
p_s1d <- create_stacked_bar(class_abundance_norm, "Class", 15, TRUE)

fig_s1_combined <- (p_s1a + p_s1b) / (p_s1c + p_s1d) +
  plot_annotation(
    tag_levels = 'a',
    title = "Figure S1: Predicted viral host composition across groundwater depths"
  ) &
  theme(plot.tag = element_text(size = 18, face = "bold"))

print(fig_s1_combined)


```



### Task 6: Save outputs

```{r}
#| label: task6-save-outputs

figures_dir <- path_target("figures")
data_dir <- path_target("data")
dir.create(figures_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(data_dir, recursive = TRUE, showWarnings = FALSE)

# Save figures
ggsave(file.path(figures_dir, "FigS1a_phylum_original.png"), p_s1a, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1b_class_original.png"), p_s1b, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1c_phylum_normalized.png"), p_s1c, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1d_class_normalized.png"), p_s1d, width = 6, height = 6, dpi = 300)
ggsave(file.path(figures_dir, "FigS1_combined_all_panels.png"), fig_s1_combined, width = 12, height = 12, dpi = 300)

# Save data
write_csv(phylum_abundance_orig, file.path(data_dir, "phylum_abundance_original.csv"))
write_csv(class_abundance_orig, file.path(data_dir, "class_abundance_original.csv"))
write_csv(phylum_abundance_norm, file.path(data_dir, "phylum_abundance_normalized.csv"))
write_csv(class_abundance_norm, file.path(data_dir, "class_abundance_normalized.csv"))

message("Outputs saved to: ", figures_dir)

```
