---
title: "05-fig5-heatmap3"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "05-fig5-heatmap3"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "05-fig5-heatmap3")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "3226498a-f57a-4ff6-bfc6-7547d0ec8367")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(tidyverse)
  library(TreeSummarizedExperiment)
  library(ComplexHeatmap)      # âœ… æ–°å¢ï¼šComplexHeatmap
  library(circlize)            # âœ… æ–°å¢ï¼šcirclize (ComplexHeatmapä¾èµ–)
  library(KEGGREST)
  library(openxlsx)
  library(progress)
  library(viridis)
})

```

## Tasks

This section is designated for your workflow implementation. **Please write all your analysis and processing code here.**

Maintaining your code within this section ensures a clean project structure and facilitates reproducibility. We recommend organizing your workflow into modular tasksâ€”such as data cleaning, analysis, and visualizationâ€”using distinct code chunks.

Below is an example structure to get you started:

### Task 1: ata-extraction

```{r}
#| label: data-extraction
# ============================================================================
# STEP 1: ä»TSEåŠ è½½æ•°æ®
# ============================================================================
cat("Part 1: Loading TSE object...\n\n")

tse_path <- here::here("data", "01-tse-construction", "tse.rds")


# âœ… åŠ è½½TSEå¯¹è±¡
tse <- readRDS(tse_path)  # â† è¿™è¡Œè¢«æ¼æ‰äº†ï¼


# Extract AMG tables from metadata
amg_dramv <- metadata(tse)$amg_dramv
amg_vibrant <- metadata(tse)$amg_vibrant

message("âœ… Extracted AMG data:")
message("   DRAM-v: ", nrow(amg_dramv), " rows Ã— ", ncol(amg_dramv), " cols")
message("   VIBRANT: ", nrow(amg_vibrant), " rows Ã— ", ncol(amg_vibrant), " cols")

# Check key columns
message("   DRAM-v columns: ", paste(head(colnames(amg_dramv), 5), collapse = ", "), "...")
message("   VIBRANT columns: ", paste(head(colnames(amg_vibrant), 5), collapse = ", "), "...")

message("\nâœ… Task 1 å®Œæˆï¼\n")
```

### Task 2: annotate-kegg

```{r}
#| label: annotate-kegg
#| message: true
#| warning: true

message("=== Task 2: Annotate AMG Genes with KEGG ===")

# 2.1 æå–æ‰€æœ‰å”¯ä¸€çš„dbid
dramv_ids <- amg_dramv %>%
  select(dbid) %>%
  filter(!is.na(dbid)) %>%
  distinct() %>%
  mutate(source = "DRAM-v")

vibrant_ids <- amg_vibrant %>%
  select(dbid) %>%
  filter(!is.na(dbid)) %>%
  distinct() %>%
  mutate(source = "VIBRANT")

all_ids <- bind_rows(dramv_ids, vibrant_ids) %>%
  distinct(dbid)

message("ğŸ” æå–åˆ°å”¯ä¸€dbidæ•°é‡: ", nrow(all_ids))

# 2.2 å®šä¹‰KEGGæ³¨é‡Šå‡½æ•°
get_kegg_info <- function(id) {
  message("ğŸ§¬ æ­£åœ¨æŸ¥è¯¢: ", id)

  # KOå· (Kxxxxx)
  if (str_detect(id, "^K\\d{5}")) {
    entry <- tryCatch(keggGet(id)[[1]], error = function(e) NULL)
    if (!is.null(entry)) {
      return(tibble(
        dbid = id,
        db_type = "KEGG_KO",
        Name = entry$NAME[1] %||% NA_character_,
        Definition = entry$DEFINITION %||% NA_character_,
        Pathway = if (!is.null(entry$PATHWAY)) paste(names(entry$PATHWAY), collapse = "; ") else NA_character_,
        Module = if (!is.null(entry$MODULE)) paste(names(entry$MODULE), collapse = "; ") else NA_character_,
        Class = if (!is.null(entry$CLASS)) paste(entry$CLASS, collapse = "; ") else NA_character_
      ))
    }
  }

  # ECç¼–å· (x.x.x.x)
  if (str_detect(id, "^\\d+\\.\\d+\\.\\d+\\.\\d+")) {
    entry <- tryCatch(keggGet(paste0("ec:", id))[[1]], error = function(e) NULL)
    if (!is.null(entry)) {
      return(tibble(
        dbid = id,
        db_type = "EC_Number",
        Name = entry$NAME[1] %||% NA_character_,
        Definition = entry$DEFINITION %||% NA_character_,
        Pathway = if (!is.null(entry$PATHWAY)) paste(names(entry$PATHWAY), collapse = "; ") else NA_character_,
        Module = NA_character_,
        Class = NA_character_
      ))
    }
  }

  # æ— æ³•è¯†åˆ«çš„ID
  return(tibble(
    dbid = id,
    db_type = "Other_DB",
    Name = NA_character_,
    Definition = NA_character_,
    Pathway = NA_character_,
    Module = NA_character_,
    Class = NA_character_
  ))
}

# 2.3 æ‰§è¡Œæ³¨é‡Š
message("ğŸš€ å¼€å§‹æ³¨é‡Šæ‰€æœ‰dbidï¼Œè¯·ç¨ç­‰...")
annotations <- purrr::map_dfr(all_ids$dbid, get_kegg_info)

message("âœ… æ³¨é‡Šå®Œæˆ: ", nrow(annotations), " dbids")
message("   æœ‰Pathwayçš„: ", sum(!is.na(annotations$Pathway)))
message("   æ— Pathwayçš„: ", sum(is.na(annotations$Pathway)))

# 2.4 åˆå¹¶å›åŸå§‹è¡¨æ ¼
dramv_annotated <- left_join(amg_dramv, annotations, by = "dbid")
vibrant_annotated <- left_join(amg_vibrant, annotations, by = "dbid")

# 2.5 å¯¼å‡ºæ³¨é‡Šè¡¨æ ¼
write.xlsx(annotations, path_target("all_kegg_annotations.xlsx"), rowNames = FALSE)
write.xlsx(dramv_annotated, path_target("dramv_with_annotations.xlsx"), rowNames = FALSE)
write.xlsx(vibrant_annotated, path_target("vibrant_with_annotations.xlsx"), rowNames = FALSE)

message("ğŸ’¾ ä¿å­˜æ³¨é‡Šç»“æœ:")
message("   all_kegg_annotations.xlsx")
message("   dramv_with_annotations.xlsx")
message("   vibrant_with_annotations.xlsx")

message("\nâœ… Task 2 å®Œæˆï¼\n")
```


### Task 3: pathway-split-classify

```{r}
#| label: pathway-split-classify
#| message: true
#| warning: true

message("=== Task 3: Pathway Splitting and Classification ===")

# 3.1 è¯»å–å·²æ³¨é‡Šçš„AMGè¡¨
dramv_anno <- read.xlsx(path_target("dramv_with_annotations.xlsx"))
vibrant_anno <- read.xlsx(path_target("vibrant_with_annotations.xlsx"))

# 3.2 åˆå¹¶å¹¶æ·»åŠ æ¥æºæ ‡è®°
combined_raw <- bind_rows(
  dramv_anno %>% mutate(Source = "DRAM-v"),
  vibrant_anno %>% mutate(Source = "VIBRANT")
)

original_row_count <- nrow(combined_raw)
message("âœ… åŸå§‹æ•°æ®è¡Œæ•°: ", original_row_count)

# 3.3 æ‹†åˆ†Pathwayï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼ï¼‰
long_pathway <- combined_raw %>%
  mutate(
    has_pathway = !is.na(Pathway) & Pathway != "",
    row_id = row_number()
  ) %>%
  mutate(
    Pathway_ID = ifelse(has_pathway, Pathway, NA_character_)
  ) %>%
  separate_rows(Pathway_ID, sep = ";\\s*", convert = FALSE) %>%
  mutate(
    Pathway_ID = str_trim(Pathway_ID),
    Pathway_ID = ifelse(Pathway_ID == "", NA_character_, Pathway_ID),
    is_expanded = ifelse(has_pathway & !is.na(Pathway_ID), TRUE, FALSE)
  )

expanded_row_count <- nrow(long_pathway)
message("ğŸ” æ‰©å±•åè¡Œæ•°: ", expanded_row_count, " (å¢åŠ : ", expanded_row_count - original_row_count, ")")

# 3.4 è·å–å”¯ä¸€Pathway IDåˆ—è¡¨
pathway_ids <- unique(na.omit(long_pathway$Pathway_ID))
total_ids <- length(pathway_ids)
message("ğŸ“Š éœ€è¦æŸ¥è¯¢çš„é€šè·¯æ•°é‡: ", total_ids)

# 3.5 å®šä¹‰KEGGæŸ¥è¯¢å‡½æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
get_pathway_info <- function(map_id, index, total) {
  message(sprintf("[%d/%d] ğŸ” æŸ¥è¯¢é€šè·¯: %s", index, total, map_id))

  tryCatch({
    entry <- keggGet(map_id)[[1]]
    name <- ifelse(!is.null(entry$NAME), paste(entry$NAME, collapse = "; "), NA)
    full_class <- ifelse(!is.null(entry$CLASS), paste(entry$CLASS, collapse = "; "), NA)

     
    # âœ… ä¸ƒå¤§ç±»åŒ¹é…ï¼ˆæ·»åŠ ç¡¬ç¼–ç è§„åˆ™è¯†åˆ«1.0ç±»åˆ«ï¼‰
    top_class <- case_when(
      # âœ… æ–°å¢ï¼šç¡¬ç¼–ç è¯†åˆ«1.0 Global and overview maps (éƒ½å±äºMetabolism)
      map_id %in% c(
        "map01100",  # Metabolic pathways
        "map01110",  # Biosynthesis of secondary metabolites
        "map01120",  # Microbial metabolism in diverse environments
        "map01200",  # Carbon metabolism
        "map01210",  # 2-Oxocarboxylic acid metabolism
        "map01212",  # Fatty acid metabolism
        "map01230",  # Biosynthesis of amino acids
        "map01232",  # Nucleotide metabolism
        "map01250",  # Biosynthesis of nucleotide sugars
        "map01240",  # Biosynthesis of cofactors
        "map01220",  # Degradation of aromatic compounds
        "map01310",  # Nitrogen cycle
        "map01320"   # Sulfur cycle
      ) ~ "Metabolism",  
      
      
       # åŸæœ‰çš„åŸºäºCLASSå­—æ®µçš„åŒ¹é…
      str_detect(full_class, "Metabolism") ~ "Metabolism",
      str_detect(full_class, "Genetic Information") ~ "Genetic Information Processing",
      str_detect(full_class, "Environmental Information") ~ "Environmental Information Processing",
      str_detect(full_class, "Cellular Processes") ~ "Cellular Processes",
      str_detect(full_class, "Organismal Systems") ~ "Organismal Systems",
      str_detect(full_class, "Human Diseases") ~ "Human Diseases",
      str_detect(full_class, "Drug Development") ~ "Drug Development",
      TRUE ~ "Other"
    )

    message(sprintf("  âœ… è·å–æˆåŠŸ: %s -> %s", name, top_class))

    tibble(
      Pathway_ID = map_id,
      Pathway_Name = name,
      Pathway_Class = full_class,
      Pathway_Top_Category = top_class
    )

  }, error = function(e) {
    prefix <- substr(map_id, 4, 5)
    top_class <- case_when(
      prefix == "01" ~ "Metabolism",
      prefix == "02" ~ "Genetic Information Processing",
      prefix == "03" ~ "Environmental Information Processing",
      prefix == "04" ~ "Cellular Processes",
      prefix == "05" ~ "Organismal Systems",
      prefix == "06" ~ "Human Diseases",
      prefix == "07" ~ "Drug Development",
      TRUE ~ "Other"
    )

    message(sprintf("  âš ï¸ æŸ¥è¯¢å¤±è´¥: %s -> ä½¿ç”¨å¤‡ç”¨åˆ†ç±»: %s", e$message, top_class))

    tibble(
      Pathway_ID = map_id,
      Pathway_Name = paste("Unknown", map_id),
      Pathway_Class = NA_character_,
      Pathway_Top_Category = top_class
    )
  })
}

# 3.6 æ‰¹é‡æŸ¥è¯¢KEGG
message("â³ å¼€å§‹æ‰¹é‡æŸ¥è¯¢KEGG API...")
pathway_annotations <- tibble()

pb <- progress::progress_bar$new(
  format = "[:bar] :percent å‰©ä½™: :eta",
  total = total_ids,
  clear = FALSE
)

for (i in seq_along(pathway_ids)) {
  id <- pathway_ids[i]
  res <- get_pathway_info(id, i, total_ids)
  pathway_annotations <- bind_rows(pathway_annotations, res)
  pb$tick()

  if (i %% 10 == 0) Sys.sleep(0.3)
}

# 3.7 åˆå¹¶Pathwayæ³¨é‡Š
long_pathway_annotated <- long_pathway %>%
  left_join(pathway_annotations, by = "Pathway_ID") %>%
  mutate(
    annotation_status = case_when(
      is.na(Pathway_ID) ~ "No Pathway",
      is.na(Pathway_Name) ~ "Missing Annotation",
      str_starts(Pathway_Name, "Unknown") ~ "API Failed",
      TRUE ~ "Annotated"
    )
  )

# 3.8 ä¿å­˜ç»“æœ
write.xlsx(long_pathway_annotated, path_target("long_pathway_with_annotation.xlsx"))
message("ğŸ’¾ ä¿å­˜: long_pathway_with_annotation.xlsx")

pathway_class_ref <- pathway_annotations %>%
  distinct(Pathway_ID, Pathway_Name, Pathway_Class, Pathway_Top_Category)
write.xlsx(pathway_class_ref, path_target("pathway_classification_reference.xlsx"))
message("ğŸ’¾ ä¿å­˜: pathway_classification_reference.xlsx")

# 3.9 ç»Ÿè®¡
message("\nğŸ“Š æœ€ç»ˆç»Ÿè®¡:")
message("  - æŸ¥è¯¢æˆåŠŸçš„é€šè·¯: ", sum(!str_starts(pathway_annotations$Pathway_Name, "Unknown")), "/", total_ids)
print(table(pathway_annotations$Pathway_Top_Category))

message("\nâœ… Task 3 å®Œæˆï¼\n")


```


### Task 4: merge-tpm-metadata

```{r}
#| label: merge-tpm-metadata
#| message: true
#| warning: true

message("=== Task 4: Merge TPM and Metadata ===")

# 4.1 ä»TSEæå–TPMä¸°åº¦çŸ©é˜µ
tpm_matrix <- assays(tse)$tpm
sample_meta <- colData(tse) %>% as_tibble(rownames = "sample_id")

# 4.2 è½¬æ¢TPMä¸ºé•¿æ ¼å¼
tpm_long <- tpm_matrix %>%
  as.data.frame() %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "TPM")

message("âœ… TPMé•¿æ ¼å¼: ", nrow(tpm_long), " è¡Œ")

# 4.3 åˆå¹¶æ ·å“å…ƒæ•°æ®
tpm_long_meta <- tpm_long %>%
  left_join(sample_meta, by = "sample_id") %>%
  mutate(sample_source1 = as.character(sample_group))

message("âœ… åˆå¹¶æ ·å“å…ƒæ•°æ®å®Œæˆ")

# 4.4 è¯»å–æ‹†åˆ†åçš„pathwayè¡¨
long_pathway <- read.xlsx(path_target("long_pathway_with_annotation.xlsx"))

# 4.5 åˆå¹¶æ‰€æœ‰ä¿¡æ¯
final_df <- long_pathway %>%
  left_join(tpm_long_meta, by = "vOTU_id")

message("âœ… æœ€ç»ˆåˆå¹¶è¡¨: ", nrow(final_df), " è¡Œ")

# 4.6 ä¿å­˜
write.xlsx(final_df, path_target("full_merged_pathway_table.xlsx"), rowNames = FALSE)
message("ğŸ’¾ ä¿å­˜: full_merged_pathway_table.xlsx")

message("\nâœ… Task 4 å®Œæˆï¼\n")
```


### Task 5: dedup-calculate-tpm

```{r}
#| label: dedup-calculate-tpm
#| message: true
#| warning: true

message("=== Task 5: Deduplicate and Calculate Pathway Total TPM ===")

# 5.1 è¯»å–å®Œæ•´åˆå¹¶è¡¨
full_df <- read.xlsx(path_target("full_merged_pathway_table.xlsx"))

# 5.2 å»é‡
deduplicated_df <- full_df %>%
  arrange(vOTU_id, dbid, Pathway_ID, sample_id, 
          match(Source, c("DRAM-v", "VIBRANT"))) %>%
  distinct(vOTU_id, dbid, Pathway_ID, sample_id, .keep_all = TRUE)

message("âœ… å»é‡å®Œæˆ: ", nrow(full_df), " â†’ ", nrow(deduplicated_df))

write.xlsx(deduplicated_df, path_target("deduplicated_pathway_table.xlsx"), rowNames = FALSE)

# 5.3 æ•°æ®æ¸…æ´—
filtered_df <- deduplicated_df %>%
  filter(!is.na(Pathway_ID), !is.na(Pathway_Name), !is.na(sample_source1)) %>%
  filter(!is.na(TPM)) %>%
  mutate(Pathway_Group = ifelse(str_starts(Pathway_Top_Category, "Metabolism"), 
                                 "Metabolism", "Other"))

message("âœ… æœ‰æ•ˆPathwayè¡Œæ•°: ", nrow(filtered_df))

# 5.4 ç»Ÿè®¡æ¯ä¸ªPathwayçš„æ€»TPM
samples <- c("BS", "SA", "IA", "DA")

heatmap_matrix <- filtered_df %>%
  group_by(Pathway_ID, Pathway_Name, Pathway_Group, sample_source1) %>%
  summarise(Total_TPM = sum(TPM, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = sample_source1, values_from = Total_TPM, values_fill = 0)

final_df_stats <- heatmap_matrix %>%
  mutate(
    Total_TPM = rowSums(across(all_of(samples))),
    Samples_Expressed = rowSums(across(all_of(samples), ~ .x > 0))
  ) %>%
  arrange(desc(Total_TPM))

message("âœ… HeatmapçŸ©é˜µ: ", nrow(final_df_stats), " pathways")

write.xlsx(final_df_stats, path_target("heatmap_matrix_with_pathway_group.xlsx"), rowNames = FALSE)
message("ğŸ’¾ ä¿å­˜: heatmap_matrix_with_pathway_group.xlsx")

```




### Task 6: plot-pathway-heatmap

```{r}
#| label: plot-pathway-heatmap
#| message: true
#| warning: true
#| fig.width: 10
#| fig.height: 12

message("=== Task 6: Plot Pathway Heatmap ===")

# 6.1 è¯»å–æ•°æ®
df <- read.xlsx(path_target("heatmap_matrix_with_pathway_group.xlsx"))
samples <- c("BS", "SA", "IA", "DA")

# 6.2 æå–é€šè·¯åä¸»å¹²
df <- df %>%
  mutate(Pathway_Short = sub(";.*", "", Pathway_Name))

# 6.3 è½¬æ¢ä¸ºlog10(TPM + 1)
df_heatmap <- df %>%
  select(Pathway_Short, all_of(samples)) %>%
  mutate(across(all_of(samples), ~log10(. + 1))) %>%
  column_to_rownames("Pathway_Short")

# ç¡®ä¿åˆ—é¡ºåº
df_heatmap <- df_heatmap[, samples]

message("âœ… å‡†å¤‡ç»˜å›¾: ", nrow(df_heatmap), " pathways Ã— ", ncol(df_heatmap), " samples")

# 6.4 è¯»å–pathwayåˆ†ç±»ä¿¡æ¯ï¼ˆç”¨äºé¢œè‰²æ ‡æ³¨ï¼‰
anno_df <- read.xlsx(path_target("pathway_classification_reference.xlsx")) %>%
  mutate(Pathway_Short = sub(";.*", "", Pathway_Name)) %>%
  select(Pathway_Short, Pathway_Top_Category)

# 6.5 åŒ¹é…åˆ†ç±»å¹¶è®¾ç½®é¢œè‰²
matched <- df_heatmap %>%
  rownames_to_column("Pathway_Short") %>%
  left_join(anno_df, by = "Pathway_Short")

# ä»£è°¢é€šè·¯=æ©™è‰²ï¼Œå…¶ä»–=è“è‰²
label_colors <- ifelse(
  str_starts(matched$Pathway_Top_Category, "Metabolism"), 
  "#D97706",  # æ©™è‰²
  "#2563EB"   # è“è‰²
)

# è½¬ä¸ºçŸ©é˜µ
mat <- as.matrix(df_heatmap)

# 6.6 ç»˜åˆ¶ComplexHeatmap
message("ğŸ¨ ç»˜åˆ¶ComplexHeatmap...")

ht <- ComplexHeatmap::Heatmap(
  mat,
  name = "log10(TPM + 1)",
  col = viridis::inferno(100),
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  width = unit(10, "cm"),
  height = unit(18, "cm"),
  
  # è¡Œæ ‡ç­¾è®¾ç½®ï¼ˆå¸¦é¢œè‰²ï¼‰
  row_names_side = "left",
  row_names_gp = gpar(fontsize = 9, fontfamily = "Times", col = label_colors),
  row_names_max_width = unit(7, "cm"),
  
  # åˆ—æ ‡ç­¾è®¾ç½®
  show_column_names = TRUE,
  column_names_side = "bottom",
  column_names_rot = 0,
  column_names_gp = gpar(fontsize = 18, fontfamily = "Times", fontface = "plain"),
  
  border = TRUE,
  
  # å›¾ä¾‹è®¾ç½®
  heatmap_legend_param = list(
    title = NULL,
    at = 0:6,
    labels = as.character(0:6),
    legend_height = unit(5, "cm"),
    direction = "vertical",
    grid_height = unit(0.3, "cm"),
    labels_gp = gpar(fontsize = 10, fontfamily = "Times")
  ),
  
  # æ ‡é¢˜
  column_title = "Pathway Abundance Across Samples (log10(TPM + 1))",
  column_title_gp = gpar(fontsize = 12, fontfamily = "Times", fontface = "bold"),
  
  # ç™½è‰²è¾¹æ¡†åˆ†éš”
  cell_fun = function(j, i, x, y, width, height, fill) {
    grid.rect(x, y, width, height,
              gp = gpar(col = "white", fill = NA, lwd = 0.3))
  }
)

ComplexHeatmap::draw(ht)

# 6.7 ä¿å­˜PNG (120 DPI)
png(path_target("Fig5_pathway_heatmap.png"),
    width = 1000, height = 1000, res = 120)
draw(ht)
dev.off()

# 6.8 ä¿å­˜PDF
pdf(path_target("Fig5_pathway_heatmap.pdf"),
    width = 12, height = 16)
draw(ht)
dev.off()

# 6.9 ä¿å­˜é«˜åˆ†è¾¨ç‡PNG (300 DPI)
png(path_target("Fig5_pathway_heatmap_highres.png"),
    width = 3600, height = 4800, res = 300)
draw(ht)
dev.off()

message("ğŸ’¾ ä¿å­˜å›¾ç‰‡:")
message("   - Fig5_pathway_heatmap.png (æ ‡å‡†åˆ†è¾¨ç‡)")
message("   - Fig5_pathway_heatmap.pdf (çŸ¢é‡å›¾)")
message("   - Fig5_pathway_heatmap_highres.png (é«˜åˆ†è¾¨ç‡)")

# 6.10 ä¿å­˜æ•°æ®
write.csv(df_heatmap %>% rownames_to_column("Pathway_Short"),
          path_target("log10_TPM_heatmap_matrix.csv"), 
          row.names = FALSE)

message("\nâœ… Task 6 å®Œæˆï¼ComplexHeatmapå·²ç”Ÿæˆï¼")
message("   - ä»£è°¢é€šè·¯: æ©™è‰²æ ‡ç­¾ (#D97706)")
message("   - å…¶ä»–é€šè·¯: è“è‰²æ ‡ç­¾ (#2563EB)")
message("   - é…è‰²: inferno (é»„â†’çº¢â†’é»‘)")
```


### Task 7: Plot Top 20 AMG Gene Heatmap (Total TPMæ’åº) - ç²¾å‡†æ˜ å°„ç‰ˆ
```{r}
#| label: plot-amg-heatmap-total
#| message: true
#| warning: true
#| fig.width: 8
#| fig.height: 10

library(pheatmap)
library(RColorBrewer)

message("=== Task 7: Plot Top 20 AMG Gene Heatmap (Total TPMæ’åº) ===")

# 7.1 è¯»å–å»é‡åçš„pathwayè¡¨
df <- read.xlsx(path_target("deduplicated_pathway_table.xlsx"))

# 7.2 æ¸…ç†æ•°æ®
df_clean <- df %>%
  select(dbid, vOTU_id, sample_source1, TPM, db_desc) %>%
  filter(!is.na(dbid), !is.na(sample_source1), !is.na(TPM)) %>%
  distinct()

message("âœ… æ¸…ç†åæ•°æ®: ", nrow(df_clean), " è¡Œ")

# 7.3 å®šä¹‰ç‰¹æ®Šæ˜ å°„è¡¨ï¼ˆç²¾å‡†æŒ‡å®šçš„åŸºå› åï¼‰
special_map <- tribble(
  ~dbid, ~gene_symbol,
  # ç”¨æˆ·æŒ‡å®šçš„ç‰¹æ®Šæ˜ å°„
  "K00525", "nrdB",           # ribonucleoside-diphosphate reductase
  "EC:1.17.4.1", "nrdB",      # ä¸K00525ç›¸åŒ
  "K00973", "rfbA",           # E2.7.7.24, rfbA, rffH â†’ ç”¨rfbA
  "K01710", "rfbB",           # E4.2.1.46, rfbB, rffG â†’ ç”¨rfbB
  "K00560", "thyA",           # thymidylate synthase â†’ ç”¨thyA
  "K01520", "dut",            # dUTP pyrophosphatase â†’ ç”¨dut
  "K00558", "DNMT1",          # DNA (cytosine-5-)-methyltransferase â†’ ç”¨DNMT1
  "K17398", "DNMT3A",         # DNMT3Aä¿æŒä¸å˜
  "K00287", "folA"            # DHFR, folA â†’ ç”¨folAï¼ˆæ›´å¸¸è§ï¼‰
)

# 7.4 æå–åŸºå› æ ‡ç­¾
df_labeled <- df_clean %>%
  left_join(special_map, by = "dbid") %>%
  mutate(
    # å¦‚æœæœ‰ç‰¹æ®Šæ˜ å°„ï¼Œä½¿ç”¨ç‰¹æ®Šæ˜ å°„
    # å¦åˆ™ï¼Œæå–åˆ†å·å‰çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†
    auto_label = str_remove_all(db_desc, "\\[.*?\\]") %>%
      str_split(";", simplify = TRUE) %>%
      .[, 1] %>%
      str_trim() %>%
      str_split(",", simplify = TRUE) %>%
      .[, 1] %>%
      str_trim(),
    
    gene_symbol = if_else(is.na(gene_symbol), auto_label, gene_symbol)
  ) %>%
  select(-auto_label)

message("âœ… æ ‡ç­¾æå–å®Œæˆ")

# æ£€æŸ¥æ˜ å°„æ•ˆæœ
mapped_genes <- df_labeled %>%
  filter(dbid %in% special_map$dbid) %>%
  select(dbid, gene_symbol, db_desc) %>%
  distinct() %>%
  arrange(dbid)

if (nrow(mapped_genes) > 0) {
  message("\nâœ… ç‰¹æ®Šæ˜ å°„æ•ˆæœ:")
  print(as.data.frame(mapped_genes))
}

# 7.5 æ±‡æ€»æ¯ä¸ªåŸºå› åœ¨æ¯ä¸ªæ ·å“ä¸­çš„æ€»TPM
gene_summary <- df_labeled %>%
  group_by(gene_symbol, sample_source1) %>%
  summarise(Total_TPM = sum(TPM, na.rm = TRUE), .groups = "drop")

# 7.6 è½¬æ¢ä¸ºå®½è¡¨
gene_matrix <- gene_summary %>%
  pivot_wider(names_from = sample_source1, values_from = Total_TPM, values_fill = 0)

# 7.7 ç­›é€‰Top 20ï¼ˆæŒ‰æ‰€æœ‰æ ·å“æ€»å’Œæ’åºï¼‰
samples <- c("BS", "SA", "IA", "DA")
available_samples <- intersect(samples, colnames(gene_matrix))

gene_top20_total <- gene_matrix %>%
  mutate(Sum_TPM = rowSums(across(all_of(available_samples)))) %>%
  arrange(desc(Sum_TPM)) %>%
  slice_head(n = 20) %>%
  select(-Sum_TPM)

message("\nâœ… Top 20 AMGåŸºå›  (æŒ‰æ€»TPMæ’åº):")
print(gene_top20_total %>% select(gene_symbol, all_of(available_samples)))

# 7.8 log10è½¬æ¢
gene_log_matrix_total <- gene_top20_total %>%
  select(gene_symbol, all_of(available_samples)) %>%
  column_to_rownames("gene_symbol") %>%
  mutate(across(everything(), ~log10(.x + 1)))

gene_log_matrix_total <- gene_log_matrix_total[, available_samples]

# 7.9 è®¾ç½®è¡Œåä¸ºæ–œä½“æ ¼å¼
rownames(gene_log_matrix_total) <- paste0("italic('", rownames(gene_log_matrix_total), "')")

message("\nâœ… å‡†å¤‡ç»˜å›¾: ", nrow(gene_log_matrix_total), " genes Ã— ", ncol(gene_log_matrix_total), " samples")

# 7.10 é…è‰²
my_colors <- colorRampPalette(brewer.pal(9, "YlOrRd"))(100)

# 7.11 ç»˜åˆ¶pheatmap
p_amg_total <- pheatmap::pheatmap(
  gene_log_matrix_total,
  color = my_colors,
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_colnames = TRUE,
  show_rownames = TRUE,
  labels_row = parse(text = rownames(gene_log_matrix_total)),
  main = "",
  fontsize_row = 10,
  fontsize_col = 18,
  fontsize = 13,
  fontfamily = "Times",
  angle_col = 0,
  cellwidth = 35,
  cellheight = 12,
  border_color = "gray80"
)

# 7.12 ä¿å­˜å›¾ç‰‡
ggsave(path_target("Fig5b_top20_AMG_heatmap.png"), 
       plot = p_amg_total, width = 8, height = 10, dpi = 300)
ggsave(path_target("Fig5b_top20_AMG_heatmap.pdf"), 
       plot = p_amg_total, width = 8, height = 10)

message("\nğŸ’¾ ä¿å­˜AMGçƒ­å›¾ (Total TPMæ’åº):")
message("   - Fig5b_top20_AMG_heatmap.png")
message("   - Fig5b_top20_AMG_heatmap.pdf")

# 7.13 ä¿å­˜æ•°æ®è¡¨
write.csv(gene_log_matrix_total %>% rownames_to_column("Gene"),
          path_target("top20_AMG_total_log10_TPM_matrix.csv"), 
          row.names = FALSE)

write.xlsx(gene_top20_total, 
           path_target("top20_AMG_total_corrected.xlsx"), 
           rowNames = FALSE)

message("\nâœ… Task 7 å®Œæˆï¼")
message("   âœ“ K00525, EC:1.17.4.1 â†’ nrdB")
message("   âœ“ K00973 â†’ rfbA")
message("   âœ“ K01710 â†’ rfbB")
message("   âœ“ K00560 â†’ thyA")
message("   âœ“ K01520 â†’ dut")
message("   âœ“ K00558 â†’ DNMT1")
message("   âœ“ K17398 â†’ DNMT3A")
message("   âœ“ K00287 â†’ folA\n")

```



### Task 3: 

```{r}

```






## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r}
#| label: list-files-target
#| include: false
projthis::proj_dir_info(path_target(), tz = "CET")
```
