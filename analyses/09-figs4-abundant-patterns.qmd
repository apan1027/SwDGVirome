---
title: "09-figs4-abundant-patterns"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "09-figs4-abundant-patterns"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "09-figs4-abundant-patterns")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "e7698ad1-0507-4422-ae37-6214cde84beb")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(tidyverse)
  library(data.table)
  
  # TreeSE and mia ecosystem
  library(TreeSummarizedExperiment)

  
  # Visualization
  library(ggplot2)
  library(patchwork)
  library(scales)
  library(forcats)
})
```

## Tasks

This section is designated for your workflow implementation. **Please write all your analysis and processing code here.**

Maintaining your code within this section ensures a clean project structure and facilitates reproducibility. We recommend organizing your workflow into modular tasks‚Äîsuch as data cleaning, analysis, and visualization‚Äîusing distinct code chunks.

Below is an example structure to get you started:

### Task 1: Load TSE 
```{r}
#| label: load-data
#| message: true

message("========================================================================")
message("Loading TSE and extracting metadata...")
message("========================================================================\n")

# Load TSE
tse <- readRDS(path_source("01-tse-construction", "tse.rds"))
message("‚úÖ TSE loaded: ", ncol(tse), " samples, ", nrow(tse), " vOTUs\n")

# ============================================================================
# Extract annotation data from TSE metadata (not external files!)
# ============================================================================
message("üì• Extracting annotation data from TSE metadata...")

# Extract contig annotation (all contigs, not just representative)
contig_anno <- metadata(tse)$contig_annotation
stopifnot(!is.null(contig_anno))
message("‚úÖ contig_annotation extracted: ", nrow(contig_anno), " contigs")

# Extract IMG/VR source
imgvr <- metadata(tse)$imgvr_source
stopifnot(!is.null(imgvr))
message("‚úÖ imgvr_source extracted: ", nrow(imgvr), " entries")
message("   Columns: ", paste(colnames(imgvr), collapse = ", "), "\n")

# Note: No need to load external CSV files anymore!
# All data is self-contained in TSE metadata

```

### label: load-tse
#| message: true

message("========================================================================")
message("Loading TSE object")
message("========================================================================\n")




### Figure S4a: Abundant Viral Taxa (Family Level Bubble Plot)
```{r}
#| label: figs4a-bubble
#| message: true
#| fig.width: 8.5
#| fig.height: 6

message("========================================================================")
message("Figure S4a: Abundant Viral Taxa Bubble Plot (Family Level)")
message("========================================================================\n")

# ============================================================================
# STEP 1: Extract data from TSE using mia functions
# ============================================================================
message("üìä Extracting data from TSE...")

# Extract TPM assay
tpm_mat <- assays(tse)$tpm

# Extract family from rowData
family_df <- data.frame(
  vOTU_id = rownames(tse),
  family = as.character(rowData(tse)$family),
  stringsAsFactors = FALSE
)

# Extract sample_group from colData (rename to sample_source1 for consistency with old code)
sample_df <- data.frame(
  sample_id = colnames(tse),
  sample_source1 = as.character(colData(tse)$sample_group),  # Áõ¥Êé•Áî®sample_group!
  stringsAsFactors = FALSE
)

message("‚úÖ Data extracted from TSE")
cat("Samples:", nrow(sample_df), "\n")
cat("Sample groups:", paste(unique(sample_df$sample_source1), collapse = ", "), "\n\n")

# ============================================================================
# STEP 2: Calculate relative abundance per sample_group
# ============================================================================
message("üîç Calculating relative abundance (per sample_group)...")

# Convert to long format
abundance_long <- as.data.frame(tpm_mat) %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "tpm") %>%
  # Join sample_source1 and family
  left_join(sample_df, by = "sample_id") %>%
  left_join(family_df, by = "vOTU_id")

# Clean family names
abundance_long <- abundance_long %>%
  mutate(
    family = str_remove(family, regex("^(\\[?Family\\]?_?|f__|family_)", ignore_case = TRUE)),
    family = str_trim(family),
    family = ifelse(is.na(family) | family == "", "Unclassified virus", family)
  )

# Calculate total TPM per sample_group
sample_totals <- abundance_long %>%
  group_by(sample_source1) %>%
  summarise(total_TPM = sum(tpm, na.rm = TRUE), .groups = "drop")

# Calculate relative abundance (decimal: 0-1)
abundance_rel <- abundance_long %>%
  left_join(sample_totals, by = "sample_source1") %>%
  mutate(rel_abundance = tpm / total_TPM)

# Identify abundant vOTUs (‚â•1% = ‚â•0.01)
abundant_vOTUs <- abundance_rel %>%
  filter(rel_abundance >= 0.01) %>%
  select(sample_source1, vOTU_id, family, rel_abundance) %>%
  arrange(sample_source1, desc(rel_abundance))

message(sprintf("‚úÖ Identified %d abundant vOTU-sample pairs\n", nrow(abundant_vOTUs)))

# ============================================================================
# STEP 3: Prepare plot data
# ============================================================================
message("üìä Preparing plot data...")

# Sum abundance per family per sample_group
df_sum <- abundant_vOTUs %>%
  group_by(family, sample_source1) %>%
  summarise(total_abund = sum(rel_abundance), .groups = "drop")

# Keep top 14 families
top_families <- df_sum %>%
  group_by(family) %>%
  summarise(mean_abund = mean(total_abund), .groups = "drop") %>%
  arrange(desc(mean_abund)) %>%
  slice_head(n = 14) %>%
  pull(family)

df_sum <- df_sum %>%
  filter(family %in% top_families) %>%
  mutate(
    sample_source1 = factor(sample_source1, levels = c("BS", "SA", "IA", "DA")),
    family = fct_relevel(family, "Unclassified virus", after = 0)
  )

message("‚úÖ Plot data ready\n")

# ============================================================================
# STEP 4: Create bubble plot
# ============================================================================
message("üé® Creating bubble plot...")

p_bubble <- ggplot(df_sum, aes(x = total_abund, y = fct_rev(factor(family)), color = sample_source1)) +
  geom_point(aes(size = total_abund), alpha = 0.85) +
  scale_size_continuous(
    range = c(2, 10),
    name = "Relative Abundance",
    breaks = pretty(df_sum$total_abund, n = 4)
  ) +
  scale_x_continuous(
    breaks = seq(0, 0.6, by = 0.2),
    limits = c(0, 0.6),
    labels = number_format(accuracy = 0.1)
  ) +
  scale_color_manual(
    values = c("BS" = "#E69F00", "SA" = "#56B4E9", "IA" = "#009E73", "DA" = "#F0E442"),
    name = "Sample"
  ) +
  labs(x = "Relative abundance", y = NULL) +
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    axis.line.x = element_line(linewidth = 0.8, color = "black"),
    axis.line.y = element_line(linewidth = 0.8, color = "black"),
    axis.ticks.x = element_line(linewidth = 0.5, color = "black"),
    axis.ticks.y = element_line(linewidth = 0.5, color = "black"),
    panel.grid = element_blank(),
    axis.text.y = element_text(face = "italic", size = 18, family = "Times", color = "black"),
    axis.text.x = element_text(size = 18, family = "Times", color = "black"),
    axis.title.x = element_text(size = 20, face = "plain", family = "Times", color = "black"),
    legend.title = element_text(size = 12, face = "bold", family = "Times"),
    legend.text = element_text(size = 11, family = "Times"),
    legend.background = element_blank(),
    legend.key = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  )

print(p_bubble)

# Save
ggsave(path_target("FigS4a_bubble.pdf"), plot = p_bubble, width = 8.5, height = 6, dpi = 300)
ggsave(path_target("FigS4a_bubble.png"), plot = p_bubble, width = 8.5, height = 6, dpi = 300)
write_csv(df_sum, path_target("FigS4a_bubble_data.csv"))
write_csv(abundant_vOTUs, path_target("FigS4a_abundant_full.csv"))

message("‚úÖ Figure S4a completed!\n")
```


#| label: summary
#| message: true

cat("\n========================================================================\n")
cat("FIGURE S4 COMPLETED!\n")
cat("========================================================================\n")
cat("‚úÖ Figure S4a: Abundant Viral Taxa (Bubble Plot)\n")
cat("   - Criterion: ‚â•1% relative abundance per sample group\n")
cat("   - Display: Top 14 families\n")
cat("   - Style: Exactly matching old code\n")
cat("\n")
cat("‚úÖ Figure S4b: Ecosystem Distribution (Vertical Bar Chart)\n")
cat("   - Criterion: ‚â•1% relative abundance per sample\n")
cat("   - Denominator: Total TPM of ALL viruses\n")
cat("   - Style: Exactly matching old code\n")
cat("========================================================================\n\n")




### Figure S4b: Abundant Viral Groups - Ecosystem Distribution

```{r}
#| label: figs4b-ecosystem
#| message: true
#| fig.width: 8
#| fig.height: 6

message("========================================================================")
message("Figure S4b: Abundant Viral Groups - Ecosystem Distribution")
message("Criterion: Relative Abundance ‚â• 1% per sample")
message("Denominator: Total TPM of ALL viruses in each sample")
message("========================================================================\n")

# ============================================================================
# STEP 1: Sample mapping (exactly as old code)
# ============================================================================
sample_map <- data.frame(
  sample_id = c("FCH3CGLCCXYL2DAA", "FCH3CGLCCXYL2EAA", "FCH3CGLCCXYL4FAA", "TARATASF"),
  sample_short = c("SA", "IA", "BS", "DA"),
  stringsAsFactors = FALSE
)

# ============================================================================
# STEP 2: Extract TPM and calculate relative abundance
# ============================================================================
message("üìä Calculating relative abundance...")

# Extract TPM matrix from TSE
tpm_mat <- assays(tse)$tpm

# Convert to long format
abundance_long <- as.data.frame(tpm_mat) %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(
    cols = -vOTU_id,
    names_to = "sample_id",
    values_to = "TPM"
  ) %>%
  left_join(sample_map, by = "sample_id")

# Calculate total TPM per sample (all viruses)
sample_total_tpm_all <- abundance_long %>%
  group_by(sample_short) %>%
  summarise(total_tpm_all = sum(TPM, na.rm = TRUE), .groups = "drop")

# Calculate relative abundance
abundance_rel <- abundance_long %>%
  left_join(sample_total_tpm_all, by = "sample_short") %>%
  mutate(relative_abundance = TPM / total_tpm_all)

# Identify abundant vOTUs (‚â•1%)
abundant_votus_list <- abundance_rel %>%
  filter(relative_abundance >= 0.01) %>%
  pull(vOTU_id) %>%
  unique()

message(sprintf("‚úÖ Identified %d abundant vOTUs (‚â•1%%)\n", length(abundant_votus_list)))

# Filter abundant vOTUs
abundance_abundant <- abundance_rel %>%
  filter(vOTU_id %in% abundant_votus_list)

# ============================================================================
# STEP 3: Extract ecosystem classification (from TSE metadata, matching old code)
# ============================================================================
message("üåç Extracting ecosystem classification...")

# Function to extract Level5 (exactly as old code)
extract_level5_position5 <- function(eco_string) {
  if (is.na(eco_string) || eco_string == "") return(NA)
  parts <- strsplit(as.character(eco_string), ";")[[1]]
  parts <- trimws(parts)
  if (length(parts) >= 5 && parts[5] != "") {
    return(parts[5])
  } else {
    return(NA)
  }
}

# Extract Level5 from imgvr (now from TSE metadata)
imgvr_eco <- imgvr %>%
  select(contig_id, eco_class = `Ecosystem classification`) %>%
  mutate(level5 = sapply(eco_class, extract_level5_position5)) %>%
  filter(!is.na(level5)) %>%
  select(contig_id, level5) %>%
  distinct()

message("‚úÖ Ecosystem data extracted\n")

# ============================================================================
# STEP 4: Link ecosystem to vOTUs (using ALL contigs from metadata)
# ============================================================================
message("üîó Linking ecosystem classification (using ALL contigs)...")

# Use ALL contigs (from TSE metadata)
data_with_eco <- contig_anno %>%
  left_join(imgvr_eco, by = "contig_id") %>%
  filter(!is.na(level5))

# Combine with abundance data
abundance_abundant_eco <- abundance_abundant %>%
  filter(vOTU_id %in% data_with_eco$vOTU_id) %>%
  left_join(data_with_eco %>% select(vOTU_id, level5) %>% distinct(), by = "vOTU_id")

message("‚úÖ Ecosystem data linked\n")

# ============================================================================
# STEP 5: Calculate relative abundance per ecosystem
# ============================================================================
message("üìä Calculating ecosystem abundance...")

abundance_by_eco_abundant <- abundance_abundant_eco %>%
  filter(!is.na(level5)) %>%
  group_by(sample_short, level5) %>%
  summarise(
    level5_tpm = sum(TPM, na.rm = TRUE),
    n_viruses = n_distinct(vOTU_id),
    .groups = "drop"
  )

# Use total TPM of ALL viruses as denominator
abundance_by_eco_abundant <- abundance_by_eco_abundant %>%
  left_join(sample_total_tpm_all, by = "sample_short") %>%
  mutate(relative_abundance = level5_tpm / total_tpm_all) %>%
  select(sample_short, level5, level5_tpm, n_viruses, relative_abundance, total_tpm_all)

message(sprintf("‚úÖ Ecosystem data processed (%d abundant vOTUs with ecosystem annotation)\n",
                length(unique(abundance_abundant_eco$vOTU_id[!is.na(abundance_abundant_eco$level5)]))))

# ============================================================================
# STEP 6: Define Level5 order and colors (exactly as old code)
# ============================================================================
level5_order <- c(
  "Host-associated(human)",
  "Host-associated(plants)",
  "Host-associated(other)",
  "Marine",
  "Freshwater",
  "Aquatic(sediment)",
  "Non-marine_Saline_and_Alkaline",
  "Terrestrial(soil)",
  "Terrestrial(other)",
  "Thermal_springs",
  "Engineered"
)

host_colors <- c("#F9E2C8", "#F4CCAC", "#C4714F")
water_colors <- c("#D4F0CD", "#B8E6AD", "#99DD87", "#2E7D32")
terrestrial_colors <- c("#D9C9BD", "#6D4C41")
special_colors <- c("#E8E4D8", "#5D4037")
all_colors <- c(host_colors, water_colors, terrestrial_colors, special_colors)
color_map <- setNames(all_colors, level5_order)

# ============================================================================
# STEP 7: Prepare plot data
# ============================================================================
plot_data <- abundance_by_eco_abundant %>%
  mutate(sample_short = factor(sample_short, levels = c("BS", "SA", "IA", "DA"))) %>%
  mutate(level5 = factor(level5, levels = level5_order)) %>%
  arrange(sample_short, desc(relative_abundance))

# ============================================================================
# STEP 8: Create vertical bar chart (exactly matching old code)
# ============================================================================
message("üé® Creating vertical bar chart...")

fig <- ggplot(plot_data, aes(x = sample_short, y = relative_abundance, fill = level5)) +
  geom_col(position = "stack", width = 0.6, color = "white", linewidth = 0.2) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, 0.2),
    labels = function(x) sprintf("%.1f", x),
    expand = c(0, 0)
  ) +
  scale_x_discrete() +
  scale_fill_manual(
    values = color_map,
    name = "Level 5 Ecosystem",
    breaks = level5_order
  ) +
  labs(
    x = NULL,
    y = "Relative Abundance"
  ) +
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    axis.text.x = element_text(color = "black", size = 18, family = "Times"),
    axis.text.y = element_text(color = "black", size = 18, family = "Times"),
    axis.title.y = element_text(size = 20, face = "plain", family = "Times"),
    axis.title.x = element_blank(),
    axis.line = element_line(color = "black", linewidth = 1),
    axis.ticks = element_line(color = "black", linewidth = 0.8),
    legend.position = "right",
    legend.text = element_text(size = 11, family = "Times"),
    legend.title = element_text(size = 12, face = "bold", family = "Times"),
    legend.key.size = unit(0.5, "cm"),
    panel.grid = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background = element_rect(fill = "white", color = NA),
    plot.margin = margin(15, 20, 10, 10)
  )

print(fig)

# Save plot
ggsave(path_target("FigS4b_ecosystem.pdf"), plot = fig, width = 8, height = 6, dpi = 300)
ggsave(path_target("FigS4b_ecosystem.png"), plot = fig, width = 8, height = 6, dpi = 300)

# Save data
write_csv(abundance_by_eco_abundant, path_target("FigS4b_ecosystem_data.csv"))

message("‚úÖ Figure S4b completed and saved!\n")

```


### Task 3: Figure S4c: Predicted Bacterial Host of Abundant Viruses (Heatmap)
```{r}
#| label: figs4c-host-heatmap
#| message: true
#| fig.width: 8
#| fig.height: 10

message("========================================================================")
message("Figure S4c: Predicted Bacterial Host of Abundant Viruses (Heatmap)")
message("Confidence threshold: ‚â•75")
message("Criterion: Relative Abundance ‚â• 1% per sample group")
message("========================================================================\n")

# ============================================================================
# STEP 1: Load host prediction data from TSE metadata
# ============================================================================
message("üì• Loading host prediction data from TSE metadata...")

host_genome <- metadata(tse)$host_genome_edges

stopifnot(!is.null(host_genome))

message("‚úÖ host_genome loaded: ", nrow(host_genome), " predictions")
message("   Columns: ", paste(colnames(host_genome), collapse = ", "), "\n")

# ============================================================================
# STEP 2: Filter high-confidence host predictions (‚â•75)
# ============================================================================
CONFIDENCE_THRESHOLD <- 80

message(sprintf("üîç Filtering host predictions (confidence ‚â• %d)...\n", CONFIDENCE_THRESHOLD))

host_filtered <- host_genome %>%
  filter(Confidence.score >= CONFIDENCE_THRESHOLD) %>%
  mutate(
    Phylum = str_extract(Host.taxonomy, "(?<=p__)[^;]+"),
    Phylum = if_else(is.na(Phylum), "Unclassified", Phylum)
  )

message(sprintf("‚úÖ High-confidence predictions: %d rows", nrow(host_filtered)))
message(sprintf("‚úÖ Unique phyla: %d\n", n_distinct(host_filtered$Phylum)))

# ============================================================================
# STEP 3: Use abundant vOTU list from Fig S4a (already calculated)
# ============================================================================
message("üìã Using abundant vOTU list from Fig S4a...")

# abundant_votus_list should already exist from Fig S4b
# If not, recalculate (fallback - exactly same as S4a/S4b)
if (!exists("abundant_votus_list")) {
  message("‚ö†Ô∏è Recalculating abundant vOTUs (same definition as S4a)...")
  
  # Use TSE colData
  sample_df <- data.frame(
    sample_id = colnames(tse),
    sample_group = as.character(colData(tse)$sample_group),
    stringsAsFactors = FALSE
  )
  
  tpm_mat <- assays(tse)$tpm
  
  abundance_long <- as.data.frame(tpm_mat) %>%
    rownames_to_column("vOTU_id") %>%
    pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "TPM") %>%
    dplyr::left_join(sample_df, by = "sample_id")
  
  # Calculate total TPM per sample_group
  sample_totals <- abundance_long %>%
    group_by(sample_group) %>%
    summarise(total_TPM = sum(TPM, na.rm = TRUE), .groups = "drop")
  
  # Calculate relative abundance
  abundance_rel <- abundance_long %>%
    dplyr::left_join(sample_totals, by = "sample_group") %>%
    mutate(rel_abundance = TPM / total_TPM)
  
  # Identify abundant vOTUs (>= 1% = >= 0.01)
  abundant_votus_list <- abundance_rel %>%
    filter(rel_abundance >= 0.01) %>%
    pull(vOTU_id) %>%
    unique()
}

message(sprintf("‚úÖ Abundant vOTUs: %d\n", length(abundant_votus_list)))

# ============================================================================
# STEP 4: Filter host predictions for abundant vOTUs
# ============================================================================
message("üîó Filtering host predictions for abundant vOTUs...")

host_abundant <- host_filtered %>%
  filter(vOTU_id %in% abundant_votus_list)

message(sprintf("‚úÖ Abundant vOTUs with host predictions: %d\n", n_distinct(host_abundant$vOTU_id)))

# ============================================================================
# STEP 5: Prepare abundance data for abundant vOTUs
# ============================================================================
message("üìä Preparing abundance data...")

# Use TSE colData (consistent with S4a and S4b)
sample_df <- data.frame(
  sample_id = colnames(tse),
  sample_group = as.character(colData(tse)$sample_group),
  stringsAsFactors = FALSE
)

# Extract TPM for abundant vOTUs
tpm_mat <- assays(tse)$tpm

tpm_abundant <- as.data.frame(tpm_mat) %>%
  rownames_to_column("vOTU_id") %>%
  filter(vOTU_id %in% abundant_votus_list) %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "tpm") %>%
  dplyr::left_join(sample_df, by = "sample_id") %>%
  filter(!is.na(sample_group))

message("‚úÖ Abundance data prepared\n")

# ============================================================================
# STEP 6: Create heatmap data (presence/absence by Phylum)
# ============================================================================
message("üóÇÔ∏è Creating heatmap data...")

# Combine host predictions with abundance (many-to-many expected)
host_abundance <- host_abundant %>%
  dplyr::left_join(tpm_abundant, by = "vOTU_id", relationship = "many-to-many")

# Calculate presence/absence per sample and Phylum
heatmap_data <- host_abundance %>%
  filter(tpm > 0) %>%
  group_by(sample_group, Phylum) %>%
  summarise(
    n_vOTUs = n_distinct(vOTU_id),
    presence = 1,
    .groups = "drop"
  )

# Complete the grid (all samples √ó all phyla)
all_samples <- c("BS", "SA", "IA", "DA")
all_phyla <- unique(host_filtered$Phylum)

heatmap_data_complete <- expand.grid(
  sample_group = all_samples,
  Phylum = all_phyla,
  stringsAsFactors = FALSE
) %>%
  dplyr::left_join(heatmap_data, by = c("sample_group", "Phylum")) %>%
  mutate(
    n_vOTUs = if_else(is.na(n_vOTUs), 0, as.numeric(n_vOTUs)),
    presence = if_else(is.na(presence), 0, presence)
  )

message(sprintf("‚úÖ Heatmap data ready: %d phyla detected\n", sum(heatmap_data_complete$presence > 0)))

# ============================================================================
# STEP 7: Create heatmap plot
# ============================================================================
message("üé® Creating heatmap...")

# Set factor levels
heatmap_data_complete$sample_group <- factor(
  heatmap_data_complete$sample_group, 
  levels = c("BS", "SA", "IA", "DA")
)

# Order phyla by total presence
phylum_order <- heatmap_data_complete %>%
  group_by(Phylum) %>%
  summarise(total_presence = sum(presence), .groups = "drop") %>%
  arrange(desc(total_presence)) %>%
  pull(Phylum)

heatmap_data_complete$Phylum <- factor(heatmap_data_complete$Phylum, levels = phylum_order)

# Create plot
p_heatmap <- ggplot(heatmap_data_complete, aes(x = sample_group, y = Phylum)) +
  geom_tile(aes(fill = factor(presence)), color = "white", linewidth = 1) +
  scale_fill_manual(
    values = c("0" = "gray90", "1" = "#FC8D62"),  # ‚Üê Ê©ôËâ≤ÔºåÂíå S5c ÁöÑÁªøËâ≤Âå∫ÂàÜ
    guide = "none"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    text = element_text(family = "Times"),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 18, family = "Times", color = "black"),
    axis.text.y = element_text(color = "black", size = 18, family = "Times", face = "italic"),
    axis.title = element_blank(),
    legend.position = "none",
    panel.grid = element_blank(),
    plot.margin = margin(10, 10, 10, 10)
  )

print(p_heatmap)

# Save plot
ggsave(path_target("FigS4c_host_heatmap.pdf"), plot = p_heatmap, width = 8, height = 10, dpi = 300)
ggsave(path_target("FigS4c_host_heatmap.png"), plot = p_heatmap, width = 8, height = 10, dpi = 300)

# Save data
write_csv(heatmap_data_complete, path_target("FigS4c_host_heatmap_data.csv"))

# Summary statistics
summary_data <- heatmap_data_complete %>%
  group_by(sample_group) %>%
  summarise(
    n_phyla_present = sum(presence > 0),
    n_vOTUs_total = sum(n_vOTUs),
    .groups = "drop"
  )

write_csv(summary_data, path_target("FigS4c_summary.csv"))

message("‚úÖ Figure S4c completed and saved!\n")

# Print summary
cat("\n========================================================================\n")
cat("üìä Summary Statistics:\n")
cat("========================================================================\n")
print(summary_data)
cat("========================================================================\n\n")

```

