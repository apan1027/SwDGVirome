---
title: "04-fig4-abundant-rare-viral"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "04-fig4-abundant-rare-viral"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "04-fig4-abundant-rare-viral")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "9feba82b-ccb7-497d-925c-fc03189c98c8")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```


```{r}
#| label: packages
#| message: false
#| warning: false

library(here)
library(conflicted)
library(projthis)
library(tidyverse)
library(TreeSummarizedExperiment)
library(mia)
library(VennDiagram)
library(RColorBrewer)
library(cowplot)
library(grid)
library(gridExtra)

conflicts_prefer(
  dplyr::count,
  dplyr::filter,
  dplyr::select,
  dplyr::lag,
  dplyr::intersect,
  dplyr::left_join,
  dplyr::right_join,
  dplyr::inner_join,
  dplyr::full_join,
  base::setdiff,
  .quiet = TRUE
)

wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}

here::i_am(paste0(params$name, ".qmd"))
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)

options(dplyr.summarise.inform = FALSE)

message("✅ Scomplete")

```


### Load Data

```{r}
#| label: load-data
#| message: true

# Load TSE
tse <- readRDS(path_source("01-tse-construction", "tse.rds"))

message("✅ TSE loaded: ", nrow(tse), " vOTUs × ", ncol(tse), " samples")
message("   Sample groups: ", paste(levels(colData(tse)$sample_group), collapse = ", "))

```

### Prepare Abundance Data

```{r}
#| label: prepare-abundance
#| message: true

cat("========================================================================\n")
cat("PREPARING ABUNDANCE DATA\n")
cat("========================================================================\n\n")

# Extract TPM assay
tpm_assay <- assay(tse, "tpm")

# Calculate relative abundance per sample
abundance_long <- as.data.frame(tpm_assay) %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(-vOTU_id, names_to = "sample_id", values_to = "TPM") %>%
  left_join(
    colData(tse) %>% as.data.frame() %>% rownames_to_column("sample_id") %>% select(sample_id, sample_group),
    by = "sample_id"
  )

# Calculate total TPM per sample group
sample_totals <- abundance_long %>%
  group_by(sample_group) %>%
  summarise(total_TPM = sum(TPM), .groups = "drop")

# Calculate relative abundance (%)
abundance_rel <- abundance_long %>%
  left_join(sample_totals, by = "sample_group") %>%
  mutate(rel_abundance = (TPM / total_TPM) * 100)

message("✅ Abundance data prepared\n")

```

### Figure 4a-c: Abundant Viruses (≥1%)
#### Identify Abundant vOTUs
```{r}
#| label: abundant-identify
#| message: true

cat("========================================================================\n")
cat("FIGURE 4a-c: ABUNDANT VIRAL GROUPS (≥1%)\n")
cat("========================================================================\n\n")

# Identify abundant vOTUs (≥1% per sample)
abundant_vOTUs <- abundance_rel %>%
  filter(rel_abundance >= 1) %>%
  select(sample_group, vOTU_id, rel_abundance) %>%
  arrange(sample_group, desc(rel_abundance))

cat("Identified", nrow(abundant_vOTUs), "abundant vOTU-sample pairs\n\n")

# Extract lists per sample group
BS_abundant <- abundant_vOTUs %>% filter(sample_group == "BS") %>% pull(vOTU_id)
SA_abundant <- abundant_vOTUs %>% filter(sample_group == "SA") %>% pull(vOTU_id)
IA_abundant <- abundant_vOTUs %>% filter(sample_group == "IA") %>% pull(vOTU_id)
DA_abundant <- abundant_vOTUs %>% filter(sample_group == "DA") %>% pull(vOTU_id)

cat("  BS:", length(BS_abundant), "abundant vOTUs\n")
cat("  SA:", length(SA_abundant), "abundant vOTUs\n")
cat("  IA:", length(IA_abundant), "abundant vOTUs\n")
cat("  DA:", length(DA_abundant), "abundant vOTUs\n\n")

```


#### Fig 4a: Abundance and Count

```{r}
#| label: fig4a-plot
#| message: true
#| fig.width: 4.5
#| fig.height: 4

# Prepare data
fig4a_data <- abundant_vOTUs %>%
  group_by(sample_group) %>%
  summarise(
    total_rel_abundance = sum(rel_abundance),
    n_contigs = n(),
    .groups = "drop"
  ) %>%
  mutate(sample_group = factor(sample_group, levels = c("BS", "SA", "IA", "DA"))) %>%
  arrange(sample_group)

# Scale factor for right Y-axis
max_abundance <- max(fig4a_data$total_rel_abundance)
max_contigs <- max(fig4a_data$n_contigs)
scale_factor <- max_abundance / max_contigs * 0.8

# Create plot
p_fig4a <- ggplot(fig4a_data, aes(x = sample_group)) +
  geom_line(aes(y = total_rel_abundance, group = 1), color = "black", linewidth = 1.2) +
  geom_point(aes(y = total_rel_abundance), size = 4, shape = 21, fill = "#E41A1C", color = "black", stroke = 1) +
  geom_line(aes(y = n_contigs * scale_factor, group = 1), color = "black", linewidth = 1.2) +
  geom_point(aes(y = n_contigs * scale_factor), size = 4, shape = 24, fill = "#377EB8", color = "black", stroke = 1) +
  scale_y_continuous(
    name = "Relative abundance",
    labels = function(x) sprintf("%.2f", x / 100),
    limits = c(0, max_abundance * 1.1),
    sec.axis = sec_axis(~ . / scale_factor, name = "Number of vOTUs")
  ) +
  labs(x = NULL) +
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "none",
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 1),
    axis.ticks = element_line(color = "black", linewidth = 0.8),
    axis.text = element_text(color = "black", size = 16, family = "Times"),
    axis.title.y = element_text(size = 16, face = "plain", family = "Times"),
    axis.title.y.right = element_text(size = 16, face = "plain", family = "Times"),
    plot.margin = margin(15, 20, 10, 10)
  )

# Add legend
p_fig4a <- p_fig4a +
  annotate("point", x = 0.6, y = max_abundance * 1.1, shape = 21, size = 3, fill = "#E41A1C", color = "black", stroke = 1) +
  annotate("text", x = 0.8, y = max_abundance * 1.1, label = "Relative abundance", hjust = 0, size = 3.5, family = "Times") +
  annotate("point", x = 0.6, y = max_abundance * 1.05, shape = 24, size = 3, fill = "#377EB8", color = "black", stroke = 1) +
  annotate("text", x = 0.8, y = max_abundance * 1.05, label = "Number of vOTUs", hjust = 0, size = 3.5, family = "Times")

print(p_fig4a)

# Save
ggsave(path_target("Fig4a.pdf"), plot = p_fig4a, width = 4.5, height = 4, dpi = 300)
ggsave(path_target("Fig4a.png"), plot = p_fig4a, width = 4.5, height = 4, dpi = 300)
write_csv(fig4a_data, path_target("Fig4a_data.csv"))

message("✅ Fig 4a completed\n")

```

#### Fig 4b: Lysogenic/Lytic Ratio

```{r}
#| label: fig4b-plot
#| message: true
#| fig.width: 4.5
#| fig.height: 4

# Get lifestyle data
abundant_lifestyle <- abundant_vOTUs %>%
  left_join(
    rowData(tse) %>% as.data.frame() %>% rownames_to_column("vOTU_id") %>% select(vOTU_id, bacphlip_lifestyle),
    by = "vOTU_id"
  ) %>%
  mutate(
    lifestyle_clean = case_when(
      bacphlip_lifestyle == "temperate" ~ "lysogenic",
      bacphlip_lifestyle == "lytic" ~ "lytic",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(lifestyle_clean))

# Calculate abundance per lifestyle
lifestyle_abundance <- abundant_lifestyle %>%
  group_by(sample_group, lifestyle_clean) %>%
  summarise(
    total_rel_abundance = sum(rel_abundance),
    n_vOTUs = n(),
    .groups = "drop"
  )

# Calculate ratio
ratio_data <- lifestyle_abundance %>%
  pivot_wider(
    names_from = lifestyle_clean,
    values_from = c(total_rel_abundance, n_vOTUs),
    values_fill = 0
  ) %>%
  mutate(
    lysogenic_lytic_ratio = if_else(
      total_rel_abundance_lytic > 0,
      total_rel_abundance_lysogenic / total_rel_abundance_lytic,
      NA_real_
    ),
    sample_group = factor(sample_group, levels = c("BS", "SA", "IA", "DA"))
  ) %>%
  filter(!is.na(lysogenic_lytic_ratio))

# Create plot
p_fig4b <- ggplot(ratio_data, aes(x = sample_group, y = lysogenic_lytic_ratio)) +
  geom_bar(stat = "identity", fill = "#9970AB", color = "black", width = 0.6, linewidth = 0.5) +
  geom_text(
    aes(label = if_else(n_vOTUs_lysogenic > 0, sprintf("n=%d", n_vOTUs_lysogenic), "")),
    vjust = -0.5, size = 5, fontface = "italic", family = "Times"
  ) +
  scale_y_continuous(
    limits = c(0, max(ratio_data$lysogenic_lytic_ratio) * 1.2),
    expand = expansion(mult = c(0, 0.05))
  ) +
  labs(x = NULL, y = "Predicted ratio of lysogenic/lytic") +
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "none",
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 1),
    axis.ticks = element_line(color = "black", linewidth = 0.8),
    axis.text = element_text(color = "black", size = 18, family = "Times"),
    axis.title.y = element_text(size = 16, face = "plain", family = "Times"),
    plot.margin = margin(15, 20, 10, 10)
  )

print(p_fig4b)

# Save
ggsave(path_target("Fig4b.pdf"), plot = p_fig4b, width = 4.5, height = 4, dpi = 300)
ggsave(path_target("Fig4b.png"), plot = p_fig4b, width = 4.5, height = 4, dpi = 300)
write_csv(ratio_data, path_target("Fig4b_ratio_data.csv"))

message("✅ Fig 4b completed\n")

```




#### Fig 4c: Venn Diagram
```{r}
#| label: fig4c-venn
#| message: true
#| fig.width: 7
#| fig.height: 7

# Create Venn diagram with EXACT formatting from original script
venn_plot_abundant <- venn.diagram(
  x = list(
    BS = BS_abundant,
    SA = SA_abundant,
    IA = IA_abundant,
    DA = DA_abundant
  ),
  filename = NULL,
  
  # ✅ Colors: Use Set2 palette
  fill = brewer.pal(4, "Set2"),
  alpha = 0.5,
  
  # ✅ Number labels (inside circles)
  cex = 2,                    # Size of numbers
  fontface = "bold",
  fontfamily = "Times",
  
  # ✅ Category labels (BS, SA, IA, DA)
  cat.cex = 2,                # Size of labels
  cat.fontface = "bold",
  cat.fontfamily = "Times",
  cat.pos = c(-20, 20, -20, 20),
  cat.dist = c(0.21, 0.21, 0.11, 0.095),
  
  # ✅ Circle borders
  col = "black",
  lwd = 2,
  lty = 'solid',
  
  # ✅ Layout
  scaled = TRUE,
  euler.d = TRUE,
  sep.dist = 0.05,
  rotation.degree = 0,
  
  # ✅ Output settings
  imagetype = "png",
  height = 2000,
  width = 2000,
  resolution = 300,
  main = NULL
)

# ✅ Display in HTML
grid.newpage()
grid.draw(venn_plot_abundant)

# Save to files
png(path_target("Fig4c.png"), width = 2000, height = 2000, res = 300)
grid.draw(venn_plot_abundant)
dev.off()

pdf(path_target("Fig4c.pdf"), width = 7, height = 7)
grid.draw(venn_plot_abundant)
dev.off()

message("✅ Fig 4c completed\n")


```


### Figure 4d-f: Rare Viruses (<0.1%)

### Identify Rare vOTUs
```{r}
#| label: rare-identify
#| message: true

cat("\n========================================================================\n")
cat("FIGURE 4d-f: RARE VIRAL GROUPS (<0.1%)\n")
cat("========================================================================\n\n")

# Identify rare vOTUs (<0.1% per sample)
rare_vOTUs <- abundance_rel %>%
  filter(rel_abundance < 0.1 & rel_abundance > 0) %>%
  select(sample_group, vOTU_id, rel_abundance) %>%
  arrange(sample_group, desc(rel_abundance))

cat("Identified", nrow(rare_vOTUs), "rare vOTU-sample pairs\n\n")

# Extract lists per sample group
BS_rare <- rare_vOTUs %>% filter(sample_group == "BS") %>% pull(vOTU_id)
SA_rare <- rare_vOTUs %>% filter(sample_group == "SA") %>% pull(vOTU_id)
IA_rare <- rare_vOTUs %>% filter(sample_group == "IA") %>% pull(vOTU_id)
DA_rare <- rare_vOTUs %>% filter(sample_group == "DA") %>% pull(vOTU_id)

cat("  BS:", length(BS_rare), "rare vOTUs\n")
cat("  SA:", length(SA_rare), "rare vOTUs\n")
cat("  IA:", length(IA_rare), "rare vOTUs\n")
cat("  DA:", length(DA_rare), "rare vOTUs\n\n")


```


#### Fig 4d: Abundance and Count

```{r}
#| label: fig4d-plot
#| message: true
#| fig.width: 4.5
#| fig.height: 4

# Prepare data
fig4d_data <- rare_vOTUs %>%
  group_by(sample_group) %>%
  summarise(
    total_rel_abundance = sum(rel_abundance),
    n_contigs = n(),
    .groups = "drop"
  ) %>%
  mutate(sample_group = factor(sample_group, levels = c("BS", "SA", "IA", "DA"))) %>%
  arrange(sample_group)

print(fig4d_data)

# Scale factor for right Y-axis
max_abundance_rare <- max(fig4d_data$total_rel_abundance)
max_contigs_rare <- max(fig4d_data$n_contigs)
scale_factor_rare <- max_abundance_rare / max_contigs_rare * 0.8

# Create plot with BLACK lines + colored points (same style as Fig 4a)
p_fig4d <- ggplot(fig4d_data, aes(x = sample_group)) +
  # Line 1: Relative abundance - BLACK line with RED points
  geom_line(aes(y = total_rel_abundance, group = 1), 
            color = "black", linewidth = 1.2) +
  geom_point(aes(y = total_rel_abundance), 
             size = 4, shape = 21, fill = "#E41A1C", color = "black", stroke = 1) +
  
  # Line 2: Number of contigs - BLACK line with BLUE points
  geom_line(aes(y = n_contigs * scale_factor_rare, group = 1), 
            color = "black", linewidth = 1.2) +
  geom_point(aes(y = n_contigs * scale_factor_rare), 
             size = 4, shape = 24, fill = "#377EB8", color = "black", stroke = 1) +
  
  # Dual Y-axes
  scale_y_continuous(
    name = "Relative abundance",
    labels = function(x) sprintf("%.2f", x / 100),
    limits = c(0, max_abundance_rare * 1.1),
    sec.axis = sec_axis(~ . / scale_factor_rare, name = "Number of vOTUs")
  ) +
  
  labs(x = NULL) +
  
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "none",
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 1),
    axis.ticks = element_line(color = "black", linewidth = 0.8),
    axis.text = element_text(color = "black", size = 16, family = "Times"),
    axis.title.y = element_text(size = 16, face = "plain", family = "Times"),
    axis.title.y.right = element_text(size = 16, face = "plain", family = "Times"),
    axis.title.x = element_blank(),
    plot.margin = margin(15, 20, 10, 10)
  )

# Add custom legend
p_fig4d <- p_fig4d +
  annotate("point", x = 0.6, y = max_abundance_rare * 1.1, 
           shape = 21, size = 3, fill = "#E41A1C", color = "black", stroke = 1) +
  annotate("text", x = 0.8, y = max_abundance_rare * 1.1, 
           label = "Relative abundance", hjust = 0, size = 3.5, family = "Times") +
  annotate("point", x = 0.6, y = max_abundance_rare * 1.05, 
           shape = 24, size = 3, fill = "#377EB8", color = "black", stroke = 1) +
  annotate("text", x = 0.8, y = max_abundance_rare * 1.05, 
           label = "Number of vOTUs", hjust = 0, size = 3.5, family = "Times")

print(p_fig4d)

# Save
ggsave(path_target("Fig4d.pdf"), plot = p_fig4d, width = 4.5, height = 4, dpi = 300)
ggsave(path_target("Fig4d.png"), plot = p_fig4d, width = 4.5, height = 4, dpi = 300)
write_csv(fig4d_data, path_target("Fig4d_data.csv"))

message("✅ Fig 4d completed\n")

```


#### Fig 4e: Lysogenic/Lytic Ratio

```{r}
#| label: fig4e-plot
#| message: true
#| fig.width: 4.5
#| fig.height: 4

# Get lifestyle data for rare vOTUs
rare_lifestyle <- rare_vOTUs %>%
  left_join(
    rowData(tse) %>% as.data.frame() %>% rownames_to_column("vOTU_id") %>% 
      select(vOTU_id, bacphlip_lifestyle),
    by = "vOTU_id"
  ) %>%
  mutate(
    lifestyle_clean = case_when(
      bacphlip_lifestyle == "temperate" ~ "lysogenic",
      bacphlip_lifestyle == "lytic" ~ "lytic",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(lifestyle_clean))

cat("Rare vOTUs with lifestyle annotation:\n")
lifestyle_table_rare <- table(rare_lifestyle$sample_group, rare_lifestyle$lifestyle_clean)
print(lifestyle_table_rare)
cat("\n")

# Calculate abundance per lifestyle
lifestyle_abundance_rare <- rare_lifestyle %>%
  group_by(sample_group, lifestyle_clean) %>%
  summarise(
    total_rel_abundance = sum(rel_abundance),
    n_vOTUs = n(),
    .groups = "drop"
  )

cat("Lifestyle abundance summary:\n")
print(lifestyle_abundance_rare)
cat("\n")

# Calculate ratio
ratio_data_rare <- lifestyle_abundance_rare %>%
  pivot_wider(
    names_from = lifestyle_clean,
    values_from = c(total_rel_abundance, n_vOTUs),
    values_fill = 0
  ) %>%
  mutate(
    lysogenic_lytic_ratio = if_else(
      total_rel_abundance_lytic > 0,
      total_rel_abundance_lysogenic / total_rel_abundance_lytic,
      NA_real_
    ),
    sample_group = factor(sample_group, levels = c("BS", "SA", "IA", "DA"))
  ) %>%
  filter(!is.na(lysogenic_lytic_ratio))

cat("Lysogenic/Lytic ratio (abundance-based):\n")
print(ratio_data_rare %>% 
  select(sample_group, lysogenic_lytic_ratio, 
         n_vOTUs_lysogenic, n_vOTUs_lytic,
         total_rel_abundance_lysogenic, total_rel_abundance_lytic))
cat("\n")

# Create bar chart (same style as Fig 4b)
p_fig4e <- ggplot(ratio_data_rare, aes(x = sample_group, y = lysogenic_lytic_ratio)) +
  geom_bar(stat = "identity", 
           fill = "#9970AB", 
           color = "black", 
           width = 0.6, 
           linewidth = 0.5) +
  geom_text(
    aes(label = if_else(n_vOTUs_lysogenic > 0, 
                        sprintf("n=%d", n_vOTUs_lysogenic), "")),
    vjust = -0.5, 
    size = 5, 
    fontface = "italic", 
    family = "Times"
  ) +
  scale_y_continuous(
    limits = c(0, max(ratio_data_rare$lysogenic_lytic_ratio) * 1.2),
    expand = expansion(mult = c(0, 0.05))
  ) +
  labs(x = NULL, y = "Predicted ratio of lysogenic/lytic") +
  theme_minimal(base_size = 22) +
  theme(
    text = element_text(family = "Times"),
    legend.position = "none",
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 1),
    axis.ticks = element_line(color = "black", linewidth = 0.8),
    axis.text = element_text(color = "black", size = 16, family = "Times"),
    axis.title.y = element_text(size = 16, face = "plain", family = "Times"),
    axis.title.x = element_blank(),
    plot.margin = margin(15, 20, 10, 10)
  )

print(p_fig4e)

# Save
ggsave(path_target("Fig4e.pdf"), plot = p_fig4e, width = 4.5, height = 4, dpi = 300)
ggsave(path_target("Fig4e.png"), plot = p_fig4e, width = 4.5, height = 4, dpi = 300)
write_csv(ratio_data_rare, path_target("Fig4e_ratio_data.csv"))

message("✅ Fig 4e completed\n")

```


#### Fig 4f: Venn Diagram

```{r}
#| label: fig4f-venn
#| message: true
#| fig.width: 7
#| fig.height: 7

# Create Venn diagram (same style as Fig 4c)
venn_plot_rare <- venn.diagram(
  x = list(
    BS = BS_rare,
    SA = SA_rare,
    IA = IA_rare,
    DA = DA_rare
  ),
  filename = NULL,
  fill = brewer.pal(4, "Set2"),
  alpha = 0.5,
  cex = 2,
  fontface = "bold",
  fontfamily = "Times",
  cat.cex = 2,
  cat.fontface = "bold",
  cat.fontfamily = "Times",
  cat.pos = c(-20, 20, -20, 20),
  cat.dist = c(0.21, 0.21, 0.11, 0.095),
  col = "black",
  lwd = 2,
  lty = 'solid',
  scaled = TRUE,
  euler.d = TRUE,
  sep.dist = 0.05,
  rotation.degree = 0,
  imagetype = "png",
  height = 2000,
  width = 2000,
  resolution = 300,
  main = NULL
)

# ✅ Display in HTML (关键！)
grid.newpage()
grid.draw(venn_plot_rare)

# Save to files
png(path_target("Fig4f.png"), width = 2000, height = 2000, res = 300)
grid.draw(venn_plot_rare)
dev.off()

pdf(path_target("Fig4f.pdf"), width = 7, height = 7)
grid.draw(venn_plot_rare)
dev.off()

message("✅ Fig 4f completed\n")

```


