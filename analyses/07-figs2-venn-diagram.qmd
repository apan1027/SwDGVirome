---
title: "07-figs2-venn-diagram"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "07-figs2-venn-diagram"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "07-figs2-venn-diagram")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "8476105e-b6a7-4037-a767-28fcd6016612")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(mia)           # Load mia first
  library(tidyverse)     
  library(VennDiagram)
  library(RColorBrewer)
  library(grid)
})
```

## Tasks

This section is designated for your workflow implementation. **Please write all your analysis and processing code here.**

Maintaining your code within this section ensures a clean project structure and facilitates reproducibility. We recommend organizing your workflow into modular tasks—such as data cleaning, analysis, and visualization—using distinct code chunks.

Below is an example structure to get you started:

### Task 1: Load TSE

```{r}
#| label: task1-load-data

tse <- readRDS(here("data", "01-tse-construction", "tse.rds"))
tpm_matrix <- assay(tse, "tpm")

sample_metadata <- colData(tse) %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  dplyr::select(sample_id, sample_group)

message("TSE loaded: ", nrow(tse), " vOTUs, ", ncol(tse), " samples")
```

### Task 2: Prepare Data

```{r}
#| label: task2-prepare-data

# Convert to long format and merge metadata
tpm_long <- tpm_matrix %>%
  as.data.frame() %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "TPM") %>%
  dplyr::left_join(sample_metadata, by = "sample_id")

# Extract vOTUs per aquifer (TPM > 0)
SA_viruses <- tpm_long %>%
  dplyr::filter(sample_group == "SA", TPM > 0) %>%
  pull(vOTU_id) %>%
  unique()

IA_viruses <- tpm_long %>%
  dplyr::filter(sample_group == "IA", TPM > 0) %>%
  pull(vOTU_id) %>%
  unique()

DA_viruses <- tpm_long %>%
  dplyr::filter(sample_group == "DA", TPM > 0) %>%
  pull(vOTU_id) %>%
  unique()

# Calculate core viruses
core_viruses <- Reduce(base::intersect, list(SA_viruses, IA_viruses, DA_viruses))

message("vOTUs identified: SA=", length(SA_viruses), 
        ", IA=", length(IA_viruses), 
        ", DA=", length(DA_viruses),
        " | Core=", length(core_viruses))
```

### Task 3: Create Venn Diagram
```{r}
#| label: task3-create-venn  # 
#| fig.width: 10
#| fig.height: 10
#| fig.asp: 1  

# Color scheme: Set2 palette (colors 2-4)
venn_colors <- RColorBrewer::brewer.pal(4, "Set2")[2:4]

# Create Venn diagram
venn_plot <- VennDiagram::venn.diagram(
  x = list(
    SA = SA_viruses,
    IA = IA_viruses,
    DA = DA_viruses
  ),
  category.names = c("SA", "IA", "DA"),
  filename = NULL,
  fill = venn_colors,
  alpha = 0.5,
  col = "black",
  lwd = 2,
  lty = "solid",
  cex = 2,
  fontface = "bold",
  fontfamily = "Times",
  cat.cex = 3,
  cat.fontface = "bold",
  cat.fontfamily = "Times",
  cat.pos = c(-30, 30, -180),
  cat.dist = c(0.08, 0.08, 0.07),
  main = NULL,
  sub = NULL,
  scaled = TRUE,
  euler.d = TRUE,
  rotation.degree = 0
)

# Display in HTML with square aspect ratio
grid::grid.newpage()
grid::pushViewport(grid::viewport(width = unit(1, "snpc"), height = unit(1, "snpc")))
grid::grid.draw(venn_plot)
grid::popViewport()

# Save PNG
png(path_target("FigS2_venn_diagram.png"), width = 2000, height = 2000, res = 300)
grid::grid.draw(venn_plot)
dev.off()

message("Venn diagram saved: ", path_target("FigS2_venn_diagram.png"))
```


