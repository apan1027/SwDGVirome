---
title: "05-fig5-heatmap"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
date: 2025-12-20
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: full
reference-location: section
citation-location: document
params:
  name: "05-fig5-heatmap"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r}
#| label: params
#| eval: !expr interactive()
#| include: false
params = list(name = "05-fig5-heatmap")
```

```{r}
#| label: setup
#| message: false
#| include: false
#| warning: false
wd <- "analyses"
if (basename(getwd()) != wd) {
  setwd(here::here(wd))
}
here::i_am(paste0(params$name, ".qmd"), uuid = "008e69a8-ea7d-4750-9b7b-10b076a2b11a")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
path_resource <- here::here(path_raw, "d00-resource")
path_data <- here::here(path_raw, paste0("d", params$name))
dir.create(path_raw, recursive = TRUE, showWarnings = FALSE)
dir.create(path_data, recursive = TRUE, showWarnings = FALSE)
dir.create(path_resource, recursive = TRUE, showWarnings = FALSE)
```

```{r}
#| label: packages
#| message: false
suppressPackageStartupMessages({
  library(here)
  library(tidyverse)
  library(TreeSummarizedExperiment)
  library(ComplexHeatmap)     
  library(circlize)            
  library(KEGGREST)
  library(openxlsx)
  library(progress)
  library(viridis)
   library(RColorBrewer)  
  library(pheatmap)   
  
})

```

## Tasks

This section is designated for your workflow implementation. **Please write all your analysis and processing code here.**

Maintaining your code within this section ensures a clean project structure and facilitates reproducibility. We recommend organizing your workflow into modular tasks—such as data cleaning, analysis, and visualization—using distinct code chunks.

Below is an example structure to get you started:

### Task 1: Data-extraction

```{r}
#| label: data-extraction
# ============================================================================
# STEP 1: 从TSE加载数据
# ============================================================================
cat("Part 1: Loading TSE object...\n\n")

tse_path <- here::here("data", "01-tse-construction", "tse.rds")


# ✅ 加载TSE对象
tse <- readRDS(tse_path)  # ← 这行被漏掉了！


# Extract AMG tables from metadata
amg_dramv <- metadata(tse)$amg_dramv
amg_vibrant <- metadata(tse)$amg_vibrant

message("✅ Extracted AMG data:")
message("   DRAM-v: ", nrow(amg_dramv), " rows × ", ncol(amg_dramv), " cols")
message("   VIBRANT: ", nrow(amg_vibrant), " rows × ", ncol(amg_vibrant), " cols")

# Check key columns
message("   DRAM-v columns: ", paste(head(colnames(amg_dramv), 5), collapse = ", "), "...")
message("   VIBRANT columns: ", paste(head(colnames(amg_vibrant), 5), collapse = ", "), "...")

message("\n✅ Task 1 完成！\n")
```

### Task 2: Annotate KEGG

```{r}
#| label: annotate-kegg
#| message: true
#| warning: false

message("=== Annotate AMG Genes with KEGG ===")

# Extract unique dbids
dramv_ids <- amg_dramv %>%
  dplyr::select(dbid) %>%
  dplyr::filter(!is.na(dbid)) %>%
  dplyr::distinct() %>%
  mutate(source = "DRAM-v")

vibrant_ids <- amg_vibrant %>%
  dplyr::select(dbid) %>%
  dplyr::filter(!is.na(dbid)) %>%
  dplyr::distinct() %>%
  mutate(source = "VIBRANT")

all_ids <- bind_rows(dramv_ids, vibrant_ids) %>%
  dplyr::distinct(dbid)

message("Total unique dbids: ", nrow(all_ids))

# KEGG annotation function
get_kegg_info <- function(id) {
  # KO number (Kxxxxx)
  if (str_detect(id, "^K\\d{5}")) {
    entry <- tryCatch(keggGet(id)[[1]], error = function(e) NULL)
    if (!is.null(entry)) {
      return(tibble(
        dbid = id,
        db_type = "KEGG_KO",
        Name = entry$NAME[1] %||% NA_character_,
        Definition = entry$DEFINITION %||% NA_character_,
        Pathway = if (!is.null(entry$PATHWAY)) paste(names(entry$PATHWAY), collapse = "; ") else NA_character_,
        Module = if (!is.null(entry$MODULE)) paste(names(entry$MODULE), collapse = "; ") else NA_character_,
        Class = if (!is.null(entry$CLASS)) paste(entry$CLASS, collapse = "; ") else NA_character_
      ))
    }
  }

  # EC number (x.x.x.x)
  if (str_detect(id, "^\\d+\\.\\d+\\.\\d+\\.\\d+")) {
    entry <- tryCatch(keggGet(paste0("ec:", id))[[1]], error = function(e) NULL)
    if (!is.null(entry)) {
      return(tibble(
        dbid = id,
        db_type = "EC_Number",
        Name = entry$NAME[1] %||% NA_character_,
        Definition = entry$DEFINITION %||% NA_character_,
        Pathway = if (!is.null(entry$PATHWAY)) paste(names(entry$PATHWAY), collapse = "; ") else NA_character_,
        Module = NA_character_,
        Class = NA_character_
      ))
    }
  }

  # Unknown ID
  return(tibble(
    dbid = id,
    db_type = "Other_DB",
    Name = NA_character_,
    Definition = NA_character_,
    Pathway = NA_character_,
    Module = NA_character_,
    Class = NA_character_
  ))
}

# Annotate all dbids
annotations <- purrr::map_dfr(all_ids$dbid, get_kegg_info)

message("Annotation completed: ", nrow(annotations), " dbids")
message("  With pathway: ", sum(!is.na(annotations$Pathway)))

# Merge annotations
dramv_annotated <- dplyr::left_join(amg_dramv, annotations, by = "dbid")
vibrant_annotated <- dplyr::left_join(amg_vibrant, annotations, by = "dbid")

# Export
write.xlsx(annotations, path_target("all_kegg_annotations.xlsx"))
write.xlsx(dramv_annotated, path_target("dramv_with_annotations.xlsx"))
write.xlsx(vibrant_annotated, path_target("vibrant_with_annotations.xlsx"))

message("✅ Task 2 completed")

```


### Task 3: Pathway-split-classify

```{r}
#| label: pathway-split-classify
#| message: true
#| warning: false

message("=== Pathway Splitting and Classification ===")

# Read annotated AMG tables
dramv_anno <- read.xlsx(path_target("dramv_with_annotations.xlsx"))
vibrant_anno <- read.xlsx(path_target("vibrant_with_annotations.xlsx"))

# Combine and add source label
combined_raw <- bind_rows(
  dramv_anno %>% mutate(Source = "DRAM-v"),
  vibrant_anno %>% mutate(Source = "VIBRANT")
)

original_row_count <- nrow(combined_raw)
message("Original rows: ", original_row_count)

# Split pathways (core step)
long_pathway <- combined_raw %>%
  mutate(
    has_pathway = !is.na(Pathway) & Pathway != "",
    row_id = row_number()
  ) %>%
  mutate(
    Pathway_ID = ifelse(has_pathway, Pathway, NA_character_)
  ) %>%
  separate_rows(Pathway_ID, sep = ";\\s*", convert = FALSE) %>%
  mutate(
    Pathway_ID = str_trim(Pathway_ID),
    Pathway_ID = ifelse(Pathway_ID == "", NA_character_, Pathway_ID),
    is_expanded = ifelse(has_pathway & !is.na(Pathway_ID), TRUE, FALSE)
  )

expanded_row_count <- nrow(long_pathway)
message("Expanded rows: ", expanded_row_count, " (+", expanded_row_count - original_row_count, ")")

# Get unique pathway IDs
pathway_ids <- unique(na.omit(long_pathway$Pathway_ID))
total_ids <- length(pathway_ids)
message("Unique pathways to query: ", total_ids)

# KEGG pathway query function
get_pathway_info <- function(map_id, index, total) {
  message(sprintf("[%d/%d] Querying: %s", index, total, map_id))

  tryCatch({
    entry <- keggGet(map_id)[[1]]
    name <- ifelse(!is.null(entry$NAME), paste(entry$NAME, collapse = "; "), NA)
    full_class <- ifelse(!is.null(entry$CLASS), paste(entry$CLASS, collapse = "; "), NA)

    # Seven major KEGG categories with hardcoded 1.0 Global maps
    top_class <- case_when(
      # Global and overview maps (all belong to Metabolism)
      map_id %in% c(
        "map01100",  # Metabolic pathways
        "map01110",  # Biosynthesis of secondary metabolites
        "map01120",  # Microbial metabolism in diverse environments
        "map01200",  # Carbon metabolism
        "map01210",  # 2-Oxocarboxylic acid metabolism
        "map01212",  # Fatty acid metabolism
        "map01230",  # Biosynthesis of amino acids
        "map01232",  # Nucleotide metabolism
        "map01250",  # Biosynthesis of nucleotide sugars
        "map01240",  # Biosynthesis of cofactors
        "map01220",  # Degradation of aromatic compounds
        "map01310",  # Nitrogen cycle
        "map01320"   # Sulfur cycle
      ) ~ "Metabolism",
      
      # Class-based matching
      str_detect(full_class, "Metabolism") ~ "Metabolism",
      str_detect(full_class, "Genetic Information") ~ "Genetic Information Processing",
      str_detect(full_class, "Environmental Information") ~ "Environmental Information Processing",
      str_detect(full_class, "Cellular Processes") ~ "Cellular Processes",
      str_detect(full_class, "Organismal Systems") ~ "Organismal Systems",
      str_detect(full_class, "Human Diseases") ~ "Human Diseases",
      str_detect(full_class, "Drug Development") ~ "Drug Development",
      TRUE ~ "Other"
    )

    message(sprintf("  Success: %s -> %s", name, top_class))

    tibble(
      Pathway_ID = map_id,
      Pathway_Name = name,
      Pathway_Class = full_class,
      Pathway_Top_Category = top_class
    )

  }, error = function(e) {
    # Fallback: classify by pathway ID prefix
    prefix <- substr(map_id, 4, 5)
    top_class <- case_when(
      prefix == "01" ~ "Metabolism",
      prefix == "02" ~ "Genetic Information Processing",
      prefix == "03" ~ "Environmental Information Processing",
      prefix == "04" ~ "Cellular Processes",
      prefix == "05" ~ "Organismal Systems",
      prefix == "06" ~ "Human Diseases",
      prefix == "07" ~ "Drug Development",
      TRUE ~ "Other"
    )

    message(sprintf("  Failed: %s -> Fallback: %s", e$message, top_class))

    tibble(
      Pathway_ID = map_id,
      Pathway_Name = paste("Unknown", map_id),
      Pathway_Class = NA_character_,
      Pathway_Top_Category = top_class
    )
  })
}

# Batch query KEGG API
message("Starting batch KEGG query...")
pathway_annotations <- tibble()

pb <- progress_bar$new(
  format = "[:bar] :percent ETA: :eta",
  total = total_ids,
  clear = FALSE
)

for (i in seq_along(pathway_ids)) {
  id <- pathway_ids[i]
  res <- get_pathway_info(id, i, total_ids)
  pathway_annotations <- bind_rows(pathway_annotations, res)
  pb$tick()

  if (i %% 10 == 0) Sys.sleep(0.3)
}

# Merge pathway annotations
long_pathway_annotated <- long_pathway %>%
  dplyr::left_join(pathway_annotations, by = "Pathway_ID") %>%
  mutate(
    annotation_status = case_when(
      is.na(Pathway_ID) ~ "No Pathway",
      is.na(Pathway_Name) ~ "Missing Annotation",
      str_starts(Pathway_Name, "Unknown") ~ "API Failed",
      TRUE ~ "Annotated"
    )
  )

# Save results
write.xlsx(long_pathway_annotated, path_target("long_pathway_with_annotation.xlsx"))
message("Saved: long_pathway_with_annotation.xlsx")

pathway_class_ref <- pathway_annotations %>%
  dplyr::distinct(Pathway_ID, Pathway_Name, Pathway_Class, Pathway_Top_Category)
write.xlsx(pathway_class_ref, path_target("pathway_classification_reference.xlsx"))
message("Saved: pathway_classification_reference.xlsx")

# Statistics
message("\nFinal statistics:")
message("  Successful queries: ", sum(!str_starts(pathway_annotations$Pathway_Name, "Unknown")), "/", total_ids)
print(table(pathway_annotations$Pathway_Top_Category))

message("\n=== Task 3 completed ===\n")

```


### Task 4: Merge TPM and Metadata

```{r}
#| label: merge-tpm-metadata
#| message: true
#| warning: false

message("=== Merge TPM and Metadata ===")

# Extract TPM matrix from TSE
tpm_matrix <- assays(tse)$tpm
sample_meta <- colData(tse) %>% as_tibble(rownames = "sample_id")

# Convert TPM to long format
tpm_long <- tpm_matrix %>%
  as.data.frame() %>%
  rownames_to_column("vOTU_id") %>%
  pivot_longer(cols = -vOTU_id, names_to = "sample_id", values_to = "TPM")

# Merge sample metadata
tpm_long_meta <- tpm_long %>%
  dplyr::left_join(sample_meta, by = "sample_id") %>%
   mutate(sample_group = as.character(sample_group)) 

# Read pathway table
long_pathway <- read.xlsx(path_target("long_pathway_with_annotation.xlsx"))

# Merge all information
final_df <- long_pathway %>%
  dplyr::left_join(tpm_long_meta, by = "vOTU_id")

message("Final merged table: ", nrow(final_df), " rows")

# Save
write.xlsx(final_df, path_target("full_merged_pathway_table.xlsx"))
message("✅ Task 4 completed")
```


### Task 5: Deduplicate and Calculate TPM

```{r}
#| label: dedup-calculate-tpm
#| message: true
#| warning: false

message("=== Deduplicate and Calculate Pathway Total TPM ===")

# Read full merged table
full_df <- read.xlsx(path_target("full_merged_pathway_table.xlsx"))

# Deduplicate
deduplicated_df <- full_df %>%
  arrange(vOTU_id, dbid, Pathway_ID, sample_id, 
          match(Source, c("DRAM-v", "VIBRANT"))) %>%
  dplyr::distinct(vOTU_id, dbid, Pathway_ID, sample_id, .keep_all = TRUE)

message("Deduplicated: ", nrow(full_df), " → ", nrow(deduplicated_df))
write.xlsx(deduplicated_df, path_target("deduplicated_pathway_table.xlsx"))

# Filter valid pathways
filtered_df <- deduplicated_df %>%
  dplyr::filter(!is.na(Pathway_ID), !is.na(Pathway_Name), !is.na(sample_group)) %>%
  dplyr::filter(!is.na(TPM)) %>%
  mutate(Pathway_Group = ifelse(str_starts(Pathway_Top_Category, "Metabolism"), 
                                 "Metabolism", "Other"))

message("Valid pathway rows: ", nrow(filtered_df))

# Calculate total TPM per pathway
samples <- c("BS", "SA", "IA", "DA")

heatmap_matrix <- filtered_df %>%
  group_by(Pathway_ID, Pathway_Name, Pathway_Group, sample_group) %>%
  summarise(Total_TPM = sum(TPM, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = sample_group, values_from = Total_TPM, values_fill = 0)

final_df_stats <- heatmap_matrix %>%
  mutate(
    Total_TPM = rowSums(across(all_of(samples))),
    Samples_Expressed = rowSums(across(all_of(samples), ~ .x > 0))
  ) %>%
  arrange(desc(Total_TPM))

message("Heatmap matrix: ", nrow(final_df_stats), " pathways")
write.xlsx(final_df_stats, path_target("heatmap_matrix_with_pathway_group.xlsx"))
message("✅ Task 5 completed")
```


### Task 6: Plot Pathway Heatmap

```{r}
#| label: plot-pathway-heatmap
#| message: true
#| warning: false
#| fig.width: 10
#| fig.height: 12

message("=== Plot Pathway Heatmap ===")

# Read data
df <- read.xlsx(path_target("heatmap_matrix_with_pathway_group.xlsx"))
samples <- c("BS", "SA", "IA", "DA")

# Extract pathway short name
df <- df %>%
  mutate(Pathway_Short = sub(";.*", "", Pathway_Name))

# Convert to log10(TPM + 1)
df_heatmap <- df %>%
  dplyr::select(Pathway_Short, all_of(samples)) %>%
  mutate(across(all_of(samples), ~log10(. + 1))) %>%
  column_to_rownames("Pathway_Short")

df_heatmap <- df_heatmap[, samples]

message("Plotting: ", nrow(df_heatmap), " pathways × ", ncol(df_heatmap), " samples")

# Read pathway classification
anno_df <- read.xlsx(path_target("pathway_classification_reference.xlsx")) %>%
  mutate(Pathway_Short = sub(";.*", "", Pathway_Name)) %>%
  dplyr::select(Pathway_Short, Pathway_Top_Category)

# Match classification and set colors
matched <- df_heatmap %>%
  rownames_to_column("Pathway_Short") %>%
  dplyr::left_join(anno_df, by = "Pathway_Short")

# Metabolism=orange, Other=blue
label_colors <- ifelse(
  str_starts(matched$Pathway_Top_Category, "Metabolism"),
  "#D97706",  # Orange
  "#2563EB"   # Blue
)

# Convert to matrix
mat <- as.matrix(df_heatmap)

# Plot ComplexHeatmap
ht <- Heatmap(
  mat,
  name = "log10(TPM + 1)",
  col = viridis::inferno(100),
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  width = unit(10, "cm"),
  height = unit(18, "cm"),
  
  row_names_side = "left",
  row_names_gp = gpar(fontsize = 9, fontfamily = "Times", col = label_colors),
  row_names_max_width = unit(7, "cm"),
  
  show_column_names = TRUE,
  column_names_side = "bottom",
  column_names_rot = 0,
  column_names_gp = gpar(fontsize = 18, fontfamily = "Times", fontface = "plain"),
  
  border = TRUE,
  
  heatmap_legend_param = list(
    title = NULL,
    at = 0:6,
    labels = as.character(0:6),
    legend_height = unit(5, "cm"),
    direction = "vertical",
    grid_height = unit(0.3, "cm"),
    labels_gp = gpar(fontsize = 10, fontfamily = "Times")
  ),
  
  column_title = "Pathway Abundance Across Samples (log10(TPM + 1))",
  column_title_gp = gpar(fontsize = 12, fontfamily = "Times", fontface = "bold"),
  
  cell_fun = function(j, i, x, y, width, height, fill) {
    grid.rect(x, y, width, height,
              gp = gpar(col = "white", fill = NA, lwd = 0.3))
  }
)

draw(ht)

# Save figures
png(path_target("Fig5_pathway_heatmap.png"), width = 1000, height = 1000, res = 120)
draw(ht)
dev.off()

pdf(path_target("Fig5_pathway_heatmap.pdf"), width = 12, height = 16)
draw(ht)
dev.off()

png(path_target("Fig5_pathway_heatmap_highres.png"), width = 3600, height = 4800, res = 300)
draw(ht)
dev.off()

# Save data
write.csv(df_heatmap %>% rownames_to_column("Pathway_Short"),
          path_target("log10_TPM_heatmap_matrix.csv"), row.names = FALSE)

message("✅ Task 6 completed")
```



### Task 7: Plot Top 20 AMG Heatmap
```{r}
#| label: plot-amg-heatmap-total
#| message: true
#| warning: false
#| fig.width: 8
#| fig.height: 10

message("=== Plot Top 20 AMG Gene Heatmap (Total TPM) ===")

# Read deduplicated pathway table
df <- read.xlsx(path_target("deduplicated_pathway_table.xlsx"))

# Clean data
df_clean <- df %>%
  dplyr::select(dbid, vOTU_id, sample_group, TPM, db_desc) %>%
  dplyr::filter(!is.na(dbid), !is.na(sample_group), !is.na(TPM)) %>%
  dplyr::distinct()

message("Clean data: ", nrow(df_clean), " rows")

# Special gene name mapping
special_map <- tribble(
  ~dbid, ~gene_symbol,
  "K00525", "nrdB",
  "EC:1.17.4.1", "nrdB",
  "K00973", "rfbA",
  "K01710", "rfbB",
  "K00560", "thyA",
  "K01520", "dut",
  "K00558", "DNMT1",
  "K17398", "DNMT3A",
  "K00287", "folA"
)

# Extract gene labels
df_labeled <- df_clean %>%
  dplyr::left_join(special_map, by = "dbid") %>%
  mutate(
    auto_label = str_remove_all(db_desc, "\\[.*?\\]") %>%
      str_split(";", simplify = TRUE) %>%
      .[, 1] %>%
      str_trim() %>%
      str_split(",", simplify = TRUE) %>%
      .[, 1] %>%
      str_trim(),
    gene_symbol = if_else(is.na(gene_symbol), auto_label, gene_symbol)
  ) %>%
  dplyr::select(-auto_label)

# Summarize total TPM per gene
gene_summary <- df_labeled %>%
  group_by(gene_symbol, sample_group) %>%
  summarise(Total_TPM = sum(TPM, na.rm = TRUE), .groups = "drop")

# Convert to wide format
gene_matrix <- gene_summary %>%
  pivot_wider(names_from = sample_group, values_from = Total_TPM, values_fill = 0)

# Select Top 20
samples <- c("BS", "SA", "IA", "DA")
available_samples <- intersect(samples, colnames(gene_matrix))

gene_top20_total <- gene_matrix %>%
  mutate(Sum_TPM = rowSums(across(all_of(available_samples)))) %>%
  arrange(desc(Sum_TPM)) %>%
  slice_head(n = 20) %>%
  dplyr::select(-Sum_TPM)

message("Top 20 AMG genes (by total TPM)")

# log10 transformation
gene_log_matrix_total <- gene_top20_total %>%
  dplyr::select(gene_symbol, all_of(available_samples)) %>%
  column_to_rownames("gene_symbol") %>%
  mutate(across(everything(), ~log10(.x + 1)))

gene_log_matrix_total <- gene_log_matrix_total[, available_samples]

# Set row names to italic format
rownames(gene_log_matrix_total) <- paste0("italic('", rownames(gene_log_matrix_total), "')")

# Color scheme
my_colors <- colorRampPalette(RColorBrewer::brewer.pal(9, "YlOrRd"))(100)

# Plot pheatmap
p_amg_total <- pheatmap::pheatmap(
  gene_log_matrix_total,
  color = my_colors,
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_colnames = TRUE,
  show_rownames = TRUE,
  labels_row = parse(text = rownames(gene_log_matrix_total)),
  main = "",
  fontsize_row = 10,
  fontsize_col = 18,
  fontsize = 13,
  fontfamily = "Times",
  angle_col = 0,
  cellwidth = 35,
  cellheight = 12,
  border_color = "gray80"
)

# Save figures
ggsave(path_target("Fig5b_top20_AMG_heatmap.png"), 
       plot = p_amg_total, width = 8, height = 10, dpi = 300)
ggsave(path_target("Fig5b_top20_AMG_heatmap.pdf"), 
       plot = p_amg_total, width = 8, height = 10)

# Save data
write.csv(gene_log_matrix_total %>% rownames_to_column("Gene"),
          path_target("top20_AMG_total_log10_TPM_matrix.csv"), row.names = FALSE)
write.xlsx(gene_top20_total, path_target("top20_AMG_total_corrected.xlsx"))

message("✅ Task 7 completed")


```

